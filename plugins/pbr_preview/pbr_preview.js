"use strict";(()=>{var M=THREE,re=Vue,ne=window.JSZip;var A="_NONE_",p={albedo:{id:"albedo",label:"Albedo",description:"The color of the material",map:"map",icon:"tonality",default:new M.Color(16777215),regex:new RegExp("(s|_)*(basecolor|color|albedo)","i")},metalness:{id:"metalness",label:"Metalness",description:"The material's metalness map",map:"metalnessMap",icon:"brightness_6",default:new M.Color(0),regex:new RegExp("[ _]*metal(lic|ness)?","i")},emissive:{id:"emissive",label:"Emissive",description:"The material's emissive map",map:"emissiveMap",icon:"wb_twilight",default:new M.Color(0),regex:new RegExp("[ _]*(emissive|emission)","i")},roughness:{id:"roughness",label:"Roughness",description:"The material's roughness map",map:"roughnessMap",icon:"grain",default:new M.Color(16777215),regex:new RegExp("[ _]*rough(ness)?","i")},height:{id:"height",label:"Height",description:"The material's height map",map:"bumpMap",icon:"landscape",default:new M.Color(16777215),regex:new RegExp("[ _]*(height|bump)","i")},normal:{id:"normal",label:"Normal",description:"The material's normal map",map:"normalMap",icon:"looks",default:new M.Color("rgb(128, 128, 255)"),regex:new RegExp("[ _]*normal","i")},ao:{id:"ao",label:"Ambient Occlusion",description:"The material's ambient occlusion map",map:"aoMap",icon:"motion_mode",default:new M.Color(16777215),regex:new RegExp("[ _]*(ao|ambientocclusion|ambient occlusion)","i")}},o={},w=[],P=[];var se=[...Object.keys(p).map(e=>p[e].id),A];w.push(()=>{o.channelProp=new Property(TextureLayer,"enum","channel",{default:A,values:se,label:"PBR Channel",exposed:!1}),o.textureChannelProp=new Property(Texture,"enum","channel",{default:A,values:se,label:"PBR Channel",exposed:!1}),o.materialTextureProp=new Property(Texture,"boolean","material",{default:!1,label:"Material Texture"}),o.pbrMaterialsProp=new Property(ModelProject,"object","pbr_materials",{default:{},exposed:!1,label:"PBR Materials"}),o.projectMaterialsProp=new Property(ModelProject,"object","bb_materials",{default:{},exposed:!1,label:"Project Materials"}),o.projectPbrModeProp=new Property(ModelProject,"boolean","pbr_active",{default:!1,exposed:!1,values:[],label:"PBR Mode"})});function S(){return Texture.selected?Texture.selected:TextureLayer.selected?TextureLayer.selected.texture:Project?Project.selected_texture?Project.selected_texture:Project.textures.find(e=>e.selected)??null:Texture.all.find(e=>e.selected)??Texture.getDefault()}function N(){return TextureLayer.selected?TextureLayer.selected:Texture.selected?.selected_layer?Texture.selected.selected_layer:Project.selected_texture!==null&&Project.selected_texture?.layers_enabled===!0?Project.selected_texture.layers.find(e=>e.selected)??Project.selected_texture.layers[0]:S()?.getActiveLayer()??null}function I(){return Project?Project.model_identifier.length>0?Project.model_identifier:Project.getDisplayName():pathToName(S()?.name??"texture")}function oe(e,a){let t;return function(...r){let n=()=>{t=void 0,e.apply(this,r)};clearTimeout(t),t=setTimeout(n,a)}}function U(e){let a=MediaPreview.renderer??new M.WebGLRenderer({alpha:!0,antialias:!0}),t=new M.Scene,r=new M.PerspectiveCamera(75,96/96,.1,1e3),n=new M.AmbientLight(16777215,.75);t.add(n);let i=new M.PointLight(16777215,1,100);i.position.set(5,5,5),t.add(i);let s=new M.SphereGeometry(1,32,32),l=e instanceof M.MeshStandardMaterial&&e.isMeshStandardMaterial?e:new M.MeshStandardMaterial({color:e.albedo,metalness:e.metalness??0,roughness:e.roughness??1,emissive:e.emissive,bumpScale:e.height??0,envMap:PreviewScene.active?.cubemap??null,envMapIntensity:.5}),g=new M.Mesh(s,l);t.add(g),r.position.x=0,r.position.y=0,r.position.z=2,a.setSize(96,96),a.render(t,r);let h=a.domElement.toDataURL();return l.dispose(),MediaPreview.renderer||(a.clear(),a.dispose()),h}function J(e,a){let t=a??document.createElement("canvas"),r=t.getContext("2d");if(!r)return t.remove(),null;let n=Math.max(Project?Project.texture_width:16,16),i=Math.max(Project?Project.texture_height:16,16);t.width=n,t.height=i,r.fillStyle=`rgb(${e.r*255}, ${e.g*255}, ${e.b*255})`,r.fillRect(0,0,n,i);let s=t.toDataURL();return a||t.remove(),s}var Oe=(e=!0)=>{let a=Project?Project.textures??Texture.all:Texture.all;return e?a.filter(t=>t.layers_enabled&&t.layers.length>0).flatMap(t=>t.layers):a},D=class e{constructor(a,t){this._scope=a??Oe(),this._materialUuid=t}merToCanvas(){let a=this.getTexture(p.emissive),t=this.getTexture(p.roughness),r=this.getTexture(p.metalness);if(!a&&!t&&!r){let{metalness:n,emissive:i,roughness:s}=this.decodeMer();n&&(r=e.makePixelatedCanvas(n)),i&&(a=e.makePixelatedCanvas(i)),s&&(t=e.makePixelatedCanvas(s))}return{emissiveMap:a,roughnessMap:t,metalnessMap:r}}getMaterial(a={}){let{emissiveMap:t,roughnessMap:r,metalnessMap:n}=Format.id.startsWith("bedrock")?this.merToCanvas():{emissiveMap:this.getTexture(p.emissive),roughnessMap:this.getTexture(p.roughness),metalnessMap:this.getTexture(p.metalness)},i=this.getTexture(p.normal);return new M.MeshStandardMaterial({map:this.getTexture(p.albedo)??e.makePixelatedCanvas(TextureLayer.selected?.canvas??Texture.all.find(s=>s.selected)?.canvas??Texture.getDefault().canvas),aoMap:this.getTexture(p.ao),bumpMap:this.getTexture(p.height),normalMap:i,normalScale:new M.Vector2(-1,1),metalnessMap:n,metalness:n?1:0,roughnessMap:r,roughness:1,emissiveMap:t,emissiveIntensity:t?1:0,emissive:t?16777215:0,envMap:PreviewScene.active?.cubemap??null,envMapIntensity:.95,alphaTest:.1,transparent:!0,...a})}renderMaterialPreview(){return U(this.getMaterial())}saveTexture(a,t){Project&&(Project.pbr_materials||(Project.pbr_materials={}),Project.pbr_materials[this._materialUuid]||(Project.pbr_materials[this._materialUuid]={}),Project.pbr_materials[this._materialUuid][a.id]=t.uuid,t.extend({channel:a.id}))}findTexture(a,t=!0){if(!Project)return null;let r=this._scope.find(g=>g.channel&&(g.channel===a||g.channel===a.id));if(r)return r;let[n,i]=typeof a=="string"?[a,new RegExp(`_*${a}(.[^.]+)?$`,"i")]:[a.id,a.regex??new RegExp(`_*${a.id}(.[^.]+)?$`,"i")];Project.pbr_materials=Project.pbr_materials??{};let s=Project.pbr_materials[this._materialUuid];if(t&&!s?.length&&n!==A)return this._scope.find(g=>i.test(g.name))??null;let l=s?.[n];return l?this._scope.find(g=>g.uuid===l)??null:null}static makePixelatedCanvas(a){let t=new M.CanvasTexture(a,void 0,void 0,void 0,M.NearestFilter,M.NearestFilter);return t.needsUpdate=!0,t}getTexture(a){let t=this.findTexture(a);return t?e.makePixelatedCanvas(t.canvas):null}static extractChannel(a,t){let r=a.canvas,{width:n,height:i}=r,s=r.getContext("2d");if(!s||!n||!i)return null;let l=document.createElement("canvas");l.width=n,l.height=i;let g=l.getContext("2d");if(!g)return null;let h={r:0,g:1,b:2,a:3}[t],{data:m}=s.getImageData(0,0,n,i),u=new Uint8ClampedArray(n*i*4);for(let d=0;d<m.length;d+=4){let f=m[d+h];u[d]=f,u[d+1]=f,u[d+2]=f,u[d+3]=255}let b=new ImageData(u,n,i);return g.putImageData(b,0,0),l}decodeMer(a=1){let t=this.findTexture("mer",!0);if(!t)return{metalness:null,emissive:null,emissiveLevel:null,roughness:null,sss:null};let r=e.extractChannel(t,"r"),n=e.extractChannel(t,"g"),i=e.extractChannel(t,"b"),s=e.extractChannel(t,"a"),l=document.createElement("canvas");l.width=t.img.width??16,l.height=t.img.height??16;let g=this.findTexture(p.albedo);g&&(l.width=g.img.width??16,l.height=g.img.height??16);let h=l.getContext("2d"),m=n?.getContext("2d"),u=g?.canvas?.getContext("2d");if(!h||!u||!m)return{metalness:r,emissive:n,roughness:i,sss:s};let b=u.getImageData(0,0,l.width,l.height),d=m.getImageData(0,0,l.width,l.height),f=new Uint8ClampedArray(l.width*l.height*4);for(let c=0;c<b.data.length;c+=4){if(d.data[c]>a){f[c]=b.data[c],f[c+1]=b.data[c+1],f[c+2]=b.data[c+2],f[c+3]=255;continue}f[c]=0,f[c+1]=0,f[c+2]=0,f[c+3]=255}return h.putImageData(new ImageData(f,l.width,l.height),0,0),{metalness:r,emissive:l,emissiveLevel:n,roughness:i,sss:s}}createMer(a=!1){let t=this.findTexture(p.metalness,a),r=this.findTexture(p.emissive,a),n=this.findTexture(p.roughness,a),i=this.findTexture("sss",!1),s=Math.max(t?.img.width??0,r?.img.width??0,n?.img.width??0,Project?Project.texture_width:0,16),l=Math.max(t?.img.height??0,r?.img.height??0,n?.img.height??0,Project?Project.texture_height:0,16),g=document.createElement("canvas");g.width=s,g.height=l;let h=g.getContext("2d");if(!h)return null;let m=t?.img?e.extractChannel(t,"r"):null,u=r?.img?e.extractChannel(r,"g"):null,b=n?.img?e.extractChannel(n,"b"):null,d=i&&i?.img?e.extractChannel(i,"a"):null,f=m?.getContext("2d")?.getImageData(0,0,s,l)??new ImageData(s,l),c=u?.getContext("2d")?.getImageData(0,0,s,l)??new ImageData(s,l),x=b?.getContext("2d")?.getImageData(0,0,s,l)??new ImageData(s,l),v=d?.getContext("2d")?.getImageData(0,0,s,l)??new ImageData(new Uint8ClampedArray(s*l*4).fill(255),s,l),_=new Uint8ClampedArray(s*l*4);for(let y=0;y<_.length;y+=4)_[y]=f.data[y],_[y+1]=c.data[y],_[y+2]=x.data[y],_[y+3]=v.data[y];return h.putImageData(new ImageData(_,s,l),0,0),g}createLabPbrOutput(a=!0){let t=this.findTexture(p.metalness,a),r=this.findTexture(p.emissive,a),n=this.findTexture(p.roughness,a),i=this.findTexture(p.normal,a),s=this.findTexture(p.height,a),l=this.findTexture(p.ao,!1),g=this.findTexture("sss",!0),h=this.findTexture("porosity",!0),m=Math.max(t?.img.width??0,r?.img.width??0,n?.img.width??0,Project?Project.texture_width:0,16),u=Math.max(t?.img.height??0,r?.img.height??0,n?.img.height??0,Project?Project.texture_height:0,16),b=document.createElement("canvas");b.width=m,b.height=u;let d=b.getContext("2d"),f=document.createElement("canvas");f.width=m,f.height=u;let c=f.getContext("2d");if(!d||!c)return null;let x=new Uint8ClampedArray(m*u*4),v=new Uint8ClampedArray(m*u*4),_=t?.canvas,y=r?.canvas,k=n?.canvas,T=g?.canvas,L=h?.canvas,C=_?.getContext("2d"),j=y?.getContext("2d"),we=k?.getContext("2d"),Te=T?.getContext("2d"),Ce=L?.getContext("2d"),Ee=C?.getImageData(0,0,m,u),H=j?.getImageData(0,0,m,u),ee=we?.getImageData(0,0,m,u),Pe=Te?.getImageData(0,0,m,u),Le=Ce?.getImageData(0,0,m,u);for(let E=0;E<x.length;E+=4){let ae=ee?1-Math.sqrt(ee.data[E]/255):0,$e=Math.min(229,Math.max(0,Math.round((Ee?.data[E]??ae)*229))),He=Le?.data[E],Ie=Pe?.data[E];if(x[E]=ae*255,x[E+1]=$e,x[E+2]=Ie??He??0,!H){x[E+3]=255;continue}let Ue=Math.round((H?.data[E]+H?.data[E+1]+H?.data[E+2])/3);x[E+3]=Ue||255}d.putImageData(new ImageData(x,m,u),0,0);let Se=i?.canvas,je=l?.canvas,De=s?.canvas,ke=Se?.getContext("2d"),Re=je?.getContext("2d"),Ae=De?.getContext("2d"),te=ke?.getImageData(0,0,m,u),Be=Re?.getImageData(0,0,m,u),Ne=Ae?.getImageData(0,0,m,u);for(let E=0;E<v.length;E+=4)v[E]=te?.data[E]??0,v[E+1]=te?.data[E+1]??0,v[E+2]=Be?.data[E+2]??255,v[E+3]=Ne?.data[E+3]||255;return c.putImageData(new ImageData(v,m,u),0,0),{specular:b,normalMap:f}}decodeLabPbrNormal(a){let t=a.img.width??16,r=a.img.height??16,n=a.canvas.getContext("2d");if(!n)return{};let i=document.createElement("canvas");i.width=t,i.height=r;let s=document.createElement("canvas");s.width=t,s.height=r;let l=document.createElement("canvas");l.width=t,l.height=r;let g=i.getContext("2d"),h=s.getContext("2d"),m=l.getContext("2d"),{data:u}=n.getImageData(0,0,t,r);if(!u||!g||!h||!m)return{};let b=new Uint8ClampedArray(t*r*4),d=new Uint8ClampedArray(t*r*4),f=new Uint8ClampedArray(t*r*4);for(let c=0;c<u.length;c+=4){let x=c+1,v=c+2,_=c+3;b[c]=u[v],b[x]=u[v],b[v]=u[v],b[_]=255,d[c]=u[c],d[x]=u[x],d[v]=255,d[_]=255,f[c]=u[_],f[x]=u[_],f[v]=u[_],f[_]=255}return g.putImageData(new ImageData(b,t,r),0,0),h.putImageData(new ImageData(d,t,r),0,0),m.putImageData(new ImageData(f,t,r),0,0),{ao:i,normal:s,heightmap:l}}decodeLabPbrSpecular(a){let t=a.img.width??16,r=a.img.height??16,n=a.canvas.getContext("2d");if(!n)return{};let i=document.createElement("canvas");i.width=t,i.height=r;let s=document.createElement("canvas");s.width=t,s.height=r;let l=document.createElement("canvas");l.width=t,l.height=r;let g=document.createElement("canvas");g.width=t,g.height=r;let h=document.createElement("canvas");h.width=t,h.height=r;let m=i.getContext("2d"),u=s.getContext("2d"),b=l.getContext("2d"),d=g.getContext("2d"),f=h.getContext("2d"),{data:c}=n.getImageData(0,0,t,r);if(!c||!m||!u||!b||!d||!f)return{};let x=new Uint8ClampedArray(t*r*4),v=new Uint8ClampedArray(t*r*4),_=new Uint8ClampedArray(t*r*4),y=new Uint8ClampedArray(t*r*4),k=new Uint8ClampedArray(t*r*4);for(let T=0;T<c.length;T+=4){let L=T+1,C=T+2,j=T+3;_[T]=255-c[T],_[L]=255-c[T],_[C]=255-c[T],_[j]=255,x[T]=c[L],x[L]=c[L],x[C]=c[L],x[j]=255,v[T]=c[j],v[L]=c[j],v[C]=c[j],v[j]=255,y[T]=0,y[L]=0,y[C]=0,y[j]=255,k[T]=c[C],k[L]=c[C],k[C]=c[C],k[j]=255,c[C]<65&&(y[T]=c[C],y[L]=c[C],y[C]=c[C],y[j]=255,k[T]=0,k[L]=0,k[C]=0,k[j]=255)}return m.putImageData(new ImageData(x,t,r),0,0),u.putImageData(new ImageData(v,t,r),0,0),b.putImageData(new ImageData(_,t,r),0,0),d.putImageData(new ImageData(y,t,r),0,0),f.putImageData(new ImageData(k,t,r),0,0),{metalness:i,emissive:s,roughness:l,sss:g,porosity:h}}createTexturesFromSpecular(a){let t=this.decodeLabPbrSpecular(a);return Object.entries(t).forEach(([r,n])=>{n&&new Texture({name:`${a.name}_${r}`,saved:!1,particle:!1,keep_size:!1}).fromDataURL(n.toDataURL()).add()}),t}createTexturesFromNormal(a){let t=this.decodeLabPbrNormal(a);return Object.entries(t).forEach(([r,n])=>{n&&new Texture({name:`${a.name}_${r}`,saved:!1,particle:!1,keep_size:!1}).fromDataURL(n.toDataURL()).add()}),t}};var O=class{constructor({lightHeight:a=.66,ambientLight:t=[.1,.1,.1],minLightIntensity:r=0,lightDiffuse:n=[1,1,1]}={}){this.lightHeight=a,this.ambientLight=t,this.minLightIntensity=r,this.lightDiffuse=n}bake(a,t,r){let n=t instanceof HTMLCanvasElement?t:this.createCanvas(t.width,t.height),i=r instanceof HTMLCanvasElement?r:this.createCanvas(r.width,r.height),s=n.getContext("2d"),l=i.getContext("2d");s.drawImage(t,0,0),l.drawImage(r,0,0);let g=s.getImageData(0,0,t.width,t.height),h=l.getImageData(0,0,r.width,r.height),m=[],u=[];for(let d=0;d<h.width;++d){u[d]=[];for(let f=0;f<h.height;++f){let c=(d+f*h.width)*4,x=[(h.data[c+0]/255-.5)*2,(h.data[c+1]/255-.5)*2,(h.data[c+2]/255-.5)*2],v=Math.sqrt(x[0]**2+x[1]**2+x[2]**2);u[d][f]=[x[0]/v,x[1]/v,x[2]/v]}}let b=d=>{let f=this.createCanvas(t.width,t.height),c=f.getContext("2d"),x=c.getImageData(0,0,f.width,f.height),v=[Math.cos(d),Math.sin(d),this.lightHeight];for(let _=0;_<h.width;++_)for(let y=0;y<h.height;++y){let k=u[_][y],T=(_+y*h.width)*4,L=[g.data[T+0]/255,g.data[T+1]/255,g.data[T+2]/255,g.data[T+3]],C=k[0]*v[0]+k[1]*v[1]+k[2]*v[2];C=Math.min(1,Math.max(this.minLightIntensity,C));let j=[C*L[0]*this.lightDiffuse[0]+this.ambientLight[0],C*L[1]*this.lightDiffuse[1]+this.ambientLight[1],C*L[2]*this.lightDiffuse[2]+this.ambientLight[2],L[3]];x.data[T+0]=Math.floor(j[0]*255),x.data[T+1]=Math.floor(j[1]*255),x.data[T+2]=Math.floor(j[2]*255),x.data[T+3]=j[3]}return c.putImageData(x,0,0),f};for(let d=0;d<a;++d){let f=Math.PI*2/a*d;m.push(b(f))}return m}createCanvas(a,t){let r=document.createElement("canvas");return r.width=a,r.height=t,r}};var ie=(e,a=8,t=!1)=>{if(!Project)return;let r=Project.selected_texture??Texture.getDefault(),n=new D(r.layers_enabled?r.layers:Project.textures,r.uuid),i=n.findTexture(p.albedo);if(!i){Blockbench.showStatusMessage("Can not bake without a base color assigned.",3e3);return}let s=n.findTexture(p.normal);if(!s){Blockbench.showStatusMessage("Can not bake without a normal map assigned.",3e3);return}let g=new O(e).bake(a,i.canvas,s.canvas),h=new Texture({name:`${i.name}_baked`,saved:!1,particle:!1,keep_size:!1,layers_enabled:!0}).fromDataURL(g[0].toDataURL()),m=t?u=>{let b=n.findTexture(p.emissive);if(!b)return u;let d=b.canvas;if(!d.getContext("2d"))return u;let c=Math.max(u.width,d.width,Project?Project.texture_width:16),x=Math.max(u.height,d.height,Project?Project.texture_height:16),v=document.createElement("canvas");v.width=c,v.height=x;let _=v.getContext("2d");return _?(_.drawImage(u,0,0),_.globalCompositeOperation="screen",_.drawImage(d,0,0),v):u}:u=>u;g.forEach((u,b)=>{new TextureLayer({name:`baked_${b+1}`,data_url:m(u).toDataURL()},h).addForEditing()}),h.add().select(),Blockbench.showQuickMessage("Textures baked \u{1F950}",2e3)};w.push(()=>{o.bakeTexturesDialog=new Dialog("bake_textures",{id:"bake_textures",title:"Bake Textures",buttons:["Bake","Cancel"],form:{ambientLight:{type:"color",label:"Ambient Light",value:"#1f1f1f"},lightDiffuse:{type:"color",label:"Light Diffuse",value:"#ffffff"},lightHeight:{type:"range",label:"Light Height",min:0,max:1,step:.01,value:.66},minLightIntensity:{type:"range",label:"Minimum Light Intensity",min:0,max:1,step:.01,value:0},directions:{type:"number",label:"Directions",value:8,min:1,max:360,step:1},blendEmissive:{type:"checkbox",label:"Blend Emissive",value:!1}},onConfirm(e){let a=new M.Color(e.ambientLight.toString()),t=new M.Color(e.lightDiffuse.toString());ie({ambientLight:[a.r,a.g,a.b],lightDiffuse:[t.r,t.g,t.b],lightHeight:Number(e.lightHeight),minLightIntensity:Number(e.minLightIntensity)},e.directions??8,e.blendEmissive??!1)}}),o.bakeTexturesAction=new Action("bake_textures",{icon:"cake",name:"Bake Textures",description:"Bakes textures for the selected PBR material",click(){o.bakeTexturesDialog?.show()}}),MenuBar.addAction(o.bakeTexturesAction,"tools")});P.push(()=>{MenuBar.removeAction("tools.bake_textures")});function le(e,a){let t=e.getTexture();if(!t||!Project)return null;let r=Project.materials[t.uuid];r.isShaderMaterial&&!Project.bb_materials[t.uuid]?Project.bb_materials[t.uuid]=r:r.isMeshStandardMaterial&&r.dispose();let n=new D(t.layers_enabled?t.layers.filter(i=>i.visible)??null:Project.textures,t.uuid).getMaterial({side:Canvas.getRenderSide(t),...a});return Project.materials[t.uuid]=M.ShaderMaterial.prototype.copy.call(n,r),t}function ce(e){return Object.values(e).filter(a=>a?(Canvas.updateAllFaces(a),!0):!1).length>0}function Fe(e,a){let t={};return e.forAllFaces(r=>{let n=le(r,a);n&&(t[n.uuid]=n)}),ce(t)}function ze(e,a){let t={};return Object.keys(e.faces).forEach(r=>{let n=e.faces[r],i=le(n,a);i&&(t[i.uuid]=i)}),ce(t)}var R=(e={})=>{Project&&(Project.pbr_active=Texture.all.length>0&&Project.elements.map(a=>a instanceof Mesh&&Fe(a,e)||a instanceof Cube&&ze(a,e)).filter(Boolean).length>0)},B=(e=100)=>oe(R,e);var q={},Z={},W=()=>Condition({modes:["edit","paint"],selected:{texture:!0},project:!0,method(){let e=S();return e&&!e.material?!0:e?.material===!0&&N()!==null&&Modes.paint}}),ue=()=>Condition({modes:["paint","edit"],selected:{texture:!0},method(){let e=S();if(e?.material&&Modes.edit)return!1;let a=N()??e;return a?.channel&&a.channel!==A}});w.push(()=>{Object.entries(p).forEach(([e,a])=>{q[e]=new Action(`assign_channel_${e}`,{icon:a.icon??"tv_options_edit_channels",name:`Assign to ${a.label.toLocaleLowerCase()} channel`,description:`Assign the selected layer to the ${a.label} channel`,category:"textures",condition:W,click(){let t=TextureLayer.selected??(Project?Project.selected_texture:null);if(!t)return;Undo.initEdit({layers:[t]}),t.extend({channel:a.id});let r=t instanceof TextureLayer?t.texture:t;r.updateChangesAfterEdit(),Project.pbr_materials[r.uuid]||(Project.pbr_materials[r.uuid]={}),Object.entries(Project.pbr_materials[r.uuid]).forEach(([n,i])=>{i===t.uuid&&(delete Project.pbr_materials[r.uuid][n],t.channel=A)}),r.uuid===t.uuid&&(Project.pbr_materials[r.uuid]={}),Project.pbr_materials[r.uuid][e]=t.uuid,Undo.finishEdit("Change channel assignment"),Blockbench.showQuickMessage(`Assigned "${t.name}" to ${a.label} channel`,2e3),R()}}),Z[e]=new Action(`select_channel_${e}`,{icon:a.icon??"tv_options_edit_channels",name:a.label??e,description:`Select the ${a.label} channel`,condition:{project:!0,selected:{texture:!0},modes:["paint","edit"],method(){let t=S();return(t?.layers_enabled?t.layers:Texture.all).some(n=>n.channel===e)}},click(){let t=Texture.selected?.layers_enabled?Texture.selected.layers:Texture.all;if(!t||!t.length)return;let r=t.find(n=>n.channel===e);r&&(Modes.options.paint.select(),r.select(),r.scrollTo())}}),Z[e].addLabel(!0,()=>a.label??e)})});P.push(()=>{[...Object.values(q),...Object.values(Z)].forEach(a=>{a.delete()})});w.push(()=>{o.unassignChannel=new Action("unassign_channel",{icon:"cancel",name:"Unassign Channel",description:"Unassign the selected layer from the channel",category:"textures",condition:ue,click(){let e=TextureLayer.selected??(Project?Project.selected_texture:null);if(!e)return;Undo.initEdit({layers:[e]});let a=e instanceof TextureLayer?e.texture:e,t=e.channel;Project.pbr_materials[a.uuid]={},e.channel=A,a.updateChangesAfterEdit(),Undo.finishEdit("Unassign channel"),Blockbench.showQuickMessage(`Unassigned "${e.name}" from ${t} channel`,2e3),B()}}),o.channelMenu=new Menu("channel_menu",[...Object.keys(p).map(e=>`assign_channel_${e}`),"unassign_channel"],{onOpen(){B()}}),o.channelSelectionMenu=new Menu("channel_selection_menu",Object.keys(p).map(e=>`select_channel_${e}`)),o.openChannelMenu=new Action("pbr_channel_menu",{name:"Assign to PBR Channel",icon:"texture",condition:()=>W()||ue(),click(e){o.channelMenu?.open(e)},children:[...Object.values(q),o.unassignChannel]}),o.showChannelMenu=new Action("show_channel_menu",{icon:"texture",name:"Assign to PBR Channel",description:"Assign the selected layer to a channel",category:"textures",condition:W,click(e){o.channelMenu?.open(e)}}),o.showChannelSelectionMenu=new Action("show_channel_select_menu",{icon:"tv_options_edit_channels",name:"Select PBR Channel",description:"Select a channel to view",category:"textures",condition:{modes:["edit","paint"],selected:{texture:!0},method(){let e=S();return(e?.layers_enabled?e.layers:Texture.all).some(t=>Object.keys(p).some(r=>t.channel===r))}},click(e){o.channelSelectionMenu?.open(e)}}),o.openChannelMenu&&(MenuBar.addAction(o.openChannelMenu,"image.0"),Texture.prototype.menu.addAction(o.openChannelMenu,"0"),TextureLayer.prototype.menu.addAction(o.openChannelMenu,"0")),Toolbars.layers.add(o.showChannelMenu,1)});P.push(()=>{MenuBar.removeAction("image.pbr_channel_menu"),Texture.prototype.menu.removeAction("pbr_channel_menu"),TextureLayer.prototype.menu.removeAction("pbr_channel_menu"),Toolbars.layers.remove(o.showChannelMenu)});function X(e,a=!1){let t=e.canvas.getContext("2d");if(!t)return null;let r=Math.max(e.img.width??e.canvas.width,Project?Project.texture_width:0,16),n=Math.max(e.img.height??e.canvas.height,Project?Project.texture_height:0,16),{data:i}=t.getImageData(0,0,r,n),s=document.createElement("canvas"),l=s.getContext("2d");if(!l)return null;let g=(c,x)=>{let v=(c+x*r)*4;return i[v]/255};s.width=r,s.height=n,l.drawImage(e.img,0,0,r,n);let h=l.getImageData(0,0,r,n),m=h.data,u=c=>{let x=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return[c[0]/x,c[1]/x,c[2]/x]};for(let c=0;c<n;c++)for(let x=0;x<r;x++){let v=g(Math.max(x-1,0),c),_=g(Math.min(x+1,r-1),c),y=g(x,Math.max(c-1,0)),k=g(x,Math.min(c+1,n-1)),T=_-v,L=k-y,C=u([-T,-L,1]),j=(c*r+x)*4;m[j]=(C[0]+1)/2*255,m[j+1]=(C[1]+1)/2*255,m[j+2]=(C[2]+1)/2*255,m[j+3]=a?g(x,c)*255:255}l.putImageData(h,0,0);let b=s.toDataURL(),d=`${e.name.replace(/_height(map)?/i,"")}_normal`;if(e instanceof TextureLayer){let c=new TextureLayer({name:d,data_url:b,visible:!0},e.texture);return c.addForEditing(),c}let f=new Texture({name:d,saved:!1,particle:!1}).fromDataURL(b);return Project&&f.add(),f}function me(e){let a=e.canvas.getContext("2d");if(!a)return null;let t=Math.max(e.img.width??e.canvas.width,Project?Project.texture_width:0,16),r=Math.max(e.img.height??e.canvas.height,Project?Project.texture_height:0,16),{data:n}=a.getImageData(0,0,t,r),i=document.createElement("canvas"),s=i.getContext("2d");if(!s)return null;let l=(d,f)=>{let c=(d+f*t)*4;return n[c]/255};i.width=t,i.height=r,s.drawImage(e.img,0,0,t,r);let g=s.getImageData(0,0,t,r),h=g.data;for(let d=0;d<r;d++)for(let f=0;f<t;f++){let c=l(Math.max(f-1,0),d),x=l(Math.min(f+1,t-1),d),v=l(f,Math.max(d-1,0)),_=l(f,Math.min(d+1,r-1)),y=x-c,k=_-v,T=Math.sqrt(y*y+k*k)*255,L=(d*t+f)*4;h[L]=T,h[L+1]=T,h[L+2]=T,h[L+3]=255}s.putImageData(g,0,0);let m=i.toDataURL(),u=`${e.name.replace(/_height(map)?/i,"")}_ao`;if(e instanceof TextureLayer){let d=new TextureLayer({name:u,data_url:m,visible:!0},e.texture);return d.addForEditing(),d}let b=new Texture({name:u,saved:!1,particle:!1,keep_size:!1}).fromDataURL(m);return Project&&b.add(),b}w.push(()=>{o.generateNormal=new Action("generate_normal",{icon:p.normal.icon??"altitude",name:"Generate Normal Map",description:"Generates a normal map from the height map",condition:()=>(N()??S())!==null,click(e){let a=N()??S()??Texture.getDefault();if(!a)return;let t=X(a);if(!t){Blockbench.showQuickMessage("Failed to generate normal map",2e3);return}t.select(e),new D(a instanceof Texture&&a.layers_enabled?a.layers:null,a.uuid).saveTexture(p.normal,t),Blockbench.showQuickMessage("Normal map generated",2e3)}}),o.generateAo=new Action("generate_ao",{icon:p.ao.icon??"motion_mode",name:"Generate Ambient Occlusion Map",description:"Generates an ambient occlusion map from the height map",condition:{selected:{texture:!0},project:!0},click(){let e=N()??S()??Texture.getDefault();if(!e)return;let a=new D(e instanceof Texture&&e.layers_enabled?e.layers:null,e.uuid),t=a.findTexture(p.normal)??X(e);if(!t){Blockbench.showQuickMessage("Unable to generate ambient occlusion map without a normal map",2e3);return}let r=me(t);if(r){a.saveTexture(p.ao,r),r.select(),Blockbench.showQuickMessage("Ambient occlusion map generated",2e3);return}Blockbench.showQuickMessage("Failed to generate ambient occlusion map",2e3)}}),MenuBar.addAction(o.generateNormal,"tools"),MenuBar.addAction(o.generateAo,"tools")});P.push(()=>{MenuBar.removeAction("tools.generate_normal")});var Ge=(e,a="texture")=>{e.toBlob(async t=>{t&&Blockbench.export({content:await t.arrayBuffer(),type:"PNG",name:`${a}_n`,extensions:["png"],resource_id:"normal_map",savetype:"image"})})},Ve=(e,a="texture")=>{e.toBlob(async t=>{t&&Blockbench.export({content:await t.arrayBuffer(),type:"PNG",name:`${a}_s`,extensions:["png"],resource_id:"specular_map",savetype:"image"})})};w.push(()=>{o.generateLabPbr=new Action("generate_lab_pbr",{icon:"experiment",name:"Generate labPBR textures",description:"Generate a specular and normal map in labPBR format for Java shaders",condition:{formats:["java_block"],project:!0},async click(){let e=S();if(!e)return;let t=new D(e.layers_enabled?e.layers:[e],e.uuid).createLabPbrOutput();if(t===null)return;let r=e.name??(Project?Project.getDisplayName():"texture");await Promise.all([Ge(t.normalMap,pathToName(r)),Ve(t.specular,pathToName(r))]),Blockbench.showQuickMessage("Exported labPBR textures")}}),o.decodeLabPbr=new Action("decode_lab_pbr",{icon:"frame_source",name:"Decode labPBR textures",description:"Decodes the selected texture into a specular or normal map in labPBR format",condition:{formats:["java"],project:!0,selected:{texture:!0}},click(){let e=TextureLayer.selected?.texture??Texture.all.find(t=>t.selected)??Texture.getDefault(),a=new D(e.layers_enabled?e.layers:[e],e.uuid);if(pathToName(e.name).endsWith("_n")){a.createTexturesFromNormal(e);return}if(pathToName(e.name).endsWith("_s")){a.createTexturesFromSpecular(e);return}Blockbench.showQuickMessage("Failed to decode labPBR texture")}}),MenuBar.addAction(o.generateLabPbr,"file.export"),MenuBar.addAction(o.decodeLabPbr,"tools")});P.push(()=>{MenuBar.removeAction("file.export.generate_lab_pbr")});w.push(()=>{o.createMaterialTexture=new Action("create_material_texture",{icon:"deployed_code",name:"Create Material Texture",description:"Creates a new texture for a PBR material",condition:{modes:["edit","paint"],project:!0},click(){if(!Project)return;let e={...p},a=new Texture({name:"New Material",saved:!1,particle:!1});a.extend({material:!0});let t=Texture.all.filter(s=>(s.selected||s.multi_selected)&&!s.material)??Texture.all,r=S(),n=r?new D(t,r.uuid):null;try{let s=n?.findTexture(p.albedo,!0)?.canvas.toDataURL()??r?.canvas.toDataURL()??J(new M.Color(8421504),a.canvas);if(!s)return;a.fromDataURL(s);let l=new TextureLayer({name:e.albedo.label,visible:!0,data_url:s,keep_size:!0},a);l.extend({channel:e.albedo.id}),l.addForEditing(),l.texture.updateChangesAfterEdit(),n?.saveTexture(e.albedo,l),delete e.albedo}catch(s){console.warn("Failed to create base color texture",s),Blockbench.showStatusMessage("Failed to create base color texture in new material",3e3)}let i=Object.keys(e).map(s=>{let l=p[s],g=n?.findTexture(l,!0),h=g?g.canvas.toDataURL():J(l.default??new M.Color(0));if(!h)return;let m=new TextureLayer({name:l.label,visible:!0,data_url:h,keep_size:!0},a);return m.extend({channel:l.id}),n?.saveTexture(l,m),m}).filter(Boolean);Undo.initEdit({textures:Texture.all,layers:i}),a.add().select(),a.activateLayers(),i.map(s=>{s.addForEditing(),a.width=Math.max(a.width,s.img.width),a.height=Math.max(a.height,s.img.height)}),a.updateChangesAfterEdit(),Undo.finishEdit("Create Material Texture")}}),MenuBar.addAction(o.createMaterialTexture,"tools"),Toolbars.texturelist.add(o.createMaterialTexture,3)});P.push(()=>{MenuBar.removeAction("tools.create_material_texture"),Toolbars.texturelist.remove("create_material_texture")});var F=(e,a)=>{let t=S()??Texture.getDefault(),r=new D(t.layers_enabled?t.layers:Project?Project.textures:null,t.uuid).createMer(!0);if(!r)throw new Error("Failed to generate MER map from selected texture.");r.toBlob(async n=>{if(!n)throw new Error("Failed to save MER map.");let[i,s]=Project?[e?`${e}_mer`:`${t.name??Project.getDisplayName()}_mer`,Project.export_path]:["mer"];Blockbench.export({content:await n.arrayBuffer(),type:"PNG",name:i,extensions:["png"],resource_id:"mer",savetype:"image",startpath:s},a)})};w.push(()=>{o.generateMer=new Action("create_mer",{icon:"lightbulb_circle",name:"Export MER",description:"Exports a texture map from the metalness, emissive, and roughness channels. (For use in Bedrock resource packs.)",condition:{formats:["bedrock","bedrock_block"],project:!0},click(){try{F()}catch(e){console.error("Failed to export MER map:",e),Blockbench.showStatusMessage("Failed to export MER map",3e3)}}}),o.decodeMer=new Action("decode_mer",{name:"Decode MER",icon:"arrow_split",condition:{formats:["bedrock","bedrock_block"],project:!0,selected:{texture:!0}},children:[{icon:"move_item",name:"Decode MER to Textures",description:"Decodes a MER texture map into metalness, emissive, and roughness channels into separate textures",click(){let e=S()??Texture.getDefault(),a=new D([e],e.uuid),t=a.decodeMer(),r=[p.metalness,p.emissive,p.roughness];Undo.initEdit({textures:[e]}),r.forEach(n=>{let i=n.id,s=t[i];if(!s){Blockbench.showStatusMessage(`Failed to decode ${n.label} channel`,3e3);return}let l=new Texture({name:`${e?.name}_${i}`,keep_size:!1}).fromDataURL(s.toDataURL());l.add(!0),a.saveTexture(n,l)}),Undo.finishEdit("Decode MER to textures")}},{icon:"move_group",name:"Decode MER to Layers",description:"Decodes a MER texture map into metalness, emissive, and roughness channels into material layers",condition:()=>S()?.layers_enabled===!0,click(){let e=S()??Texture.getDefault(),a=new D(e.layers_enabled?e.layers:[e],e.uuid),t=a.decodeMer(),r=[p.metalness,p.emissive,p.roughness];Undo.initEdit({textures:[e]}),r.forEach(n=>{let i=n.id,s=t[i];if(!s){Blockbench.showStatusMessage(`Failed to decode ${n.label} channel`,3e3);return}let l=new TextureLayer({name:`${e?.name}_${i}`,data_url:s.toDataURL()},e);a.saveTexture(n,l),l.addForEditing()}),Undo.finishEdit("Decode MER to layers")}}],click(){}}),MenuBar.addAction(o.decodeMer,"tools"),MenuBar.addAction(o.generateMer,"file.export")});P.push(()=>{MenuBar.removeAction("file.export.create_mer"),MenuBar.removeAction("tools.decode_mer")});var Qe=()=>{Project&&Project.textures.forEach(e=>{let a=new D(null,e.uuid),t=a.findTexture(p.normal,!1),r=a.findTexture(p.height,!1),n=a.findTexture(p.albedo,!1),i=a.findTexture(p.metalness,!1)?.name,s=a.findTexture(p.emissive,!1)?.name,l=a.findTexture(p.roughness,!1)?.name,g={};return n||(g.baseColor={type:"color",label:"Base Color",value:"#ff00ff"}),!i&&!s&&!l&&(g.metalness={label:"Metalness",type:"range",min:0,max:255,step:1,value:0},g.emissive={label:"Emissive",type:"range",min:0,max:255,step:1,value:0},g.roughness={label:"Roughness",type:"range",min:0,max:255,step:1,value:0}),t&&(g.depthMap={type:"checkbox",label:"Normal Map",value:"normal"}),r&&(g.depthMap={type:"checkbox",label:"Height Map",value:"heightmap"}),t&&r&&(g.depthMap={type:"radio",label:"Depth Map",options:{normal:"Normal Map",heightmap:"Height"},value:"normal"}),o.textureSetDialog=new Dialog("texture_set",{id:"texture_set",title:"Create Texture Set JSON",buttons:["Create","Cancel"],form:g,cancelIndex:1,onConfirm(h){let m=I(),u=i||s||l,b={format_version:"1.16.100","minecraft:texture_set":{color:(n?m:h.baseColor?.toHexString())??m,metalness_emissive_roughness:[h.metalness??0,h.emissive??0,h.roughness??255]}};h.depthMap==="normal"&&t||!r&&t?b["minecraft:texture_set"].normal=`${m}_normal`:(!t||h.depthMap==="heightmap")&&r&&(b["minecraft:texture_set"].heightmap=`${m}_heightmap`);let d=x=>{if(!h.depthMap)return x();let v=h.depthMap==="normal"||h.depthMap&&!r,_=v?t:r;if(!_)return x();Blockbench.export({content:_.canvas.toDataURL()??"",type:"PNG",name:`${m}_${v?"normal":"heightmap"}`,extensions:["png"],resource_id:h.depthMap,startpath:Project.export_path,savetype:"image"},y=>{b["minecraft:texture_set"][v?"normal":"heightmap"]=pathToName(y,!1),x()})},f=x=>{if(!n)return x();Blockbench.export({content:n.canvas.toDataURL(),extensions:["png"],type:"PNG",name:m,startpath:Project.export_path,savetype:"image"},v=>{b["minecraft:texture_set"].color=pathToName(v,!1),x()})},c=()=>d(()=>{f(()=>{Blockbench.export({content:JSON.stringify(b,null,2),type:"JSON",name:`${m}.texture_set`,extensions:["json"],resource_id:"texture_set",startpath:Project.export_path,savetype:"text"},()=>{Blockbench.showQuickMessage("Texture set created",2e3),o.textureSetDialog?.hide()})})});if(u){try{F(m,x=>{b["minecraft:texture_set"].metalness_emissive_roughness=pathToName(x,!1),c()})}catch(x){console.warn("Failed to export MER map:",x),Blockbench.showStatusMessage("Failed to export MER map",3e3)}return}c()}}),o.textureSetDialog.show()})};w.push(()=>{o.createTextureSet=new Action("create_texture_set",{name:"Create Texture Set",icon:"layers",description:"Creates a texture set JSON file. Generates a MER when metalness, emissive, or roughness channels are set.",click(){Qe()},condition:{formats:["bedrock","bedrock_block"],project:!0}}),MenuBar.addAction(o.createTextureSet,"file.export")});P.push(()=>{MenuBar.removeAction("file.export.create_texture_set")});w.push(()=>{o.toggleCorrectLights=new Toggle("correct_lights",{category:"preview",name:"Correct Lights",description:"Corrects the lighting in the preview",icon:"fluorescent",default:!1,onChange(e){Preview.all.forEach(a=>{a.renderer.physicallyCorrectLights=e}),Preview.selected.renderer.physicallyCorrectLights=e,Blockbench.showQuickMessage(`Physically corrected lighting is now ${e?"enabled":"disabled"}`,2e3),e&&o.togglePbr?.set(!0),R()},click(){}}),MenuBar.addAction(o.toggleCorrectLights,"preview")});P.push(()=>{MenuBar.removeAction("preview.correct_lights")});var z=()=>{!Project||!Project.bb_materials||(Project.elements.forEach(e=>{e instanceof Cube&&Object.keys(e.faces).forEach(a=>{let r=e.faces[a].getTexture();if(!r)return;let n=Project.bb_materials[r.uuid];n&&(Project.materials[r.uuid]=n)})}),Project.pbr_active=!1,Canvas.updateAll())};var de=["undo","redo","add_texture","finish_edit","finished_edit","load_project","select_preview_scene","change_texture_path","select_project","load_undo_save","add_cube"],he=()=>Project&&Project.pbr_active&&R(),Je=()=>{Blockbench.on(de.join(" "),he)},pe=()=>{de.forEach(e=>{Blockbench.removeListener(e,he)})};w.push(()=>{o.togglePbr=new Toggle("toggle_pbr",{name:"PBR Preview",description:"Toggle PBR Preview",icon:"panorama_photosphere",category:"view",default:!1,click(){},onChange(e){if(e){R(),Je(),Blockbench.showQuickMessage("PBR Preview is now enabled");return}z(),pe(),Blockbench.showQuickMessage("PBR Preview is now disabled")}}),MenuBar.addAction(o.togglePbr,"view")});P.push(()=>{pe(),MenuBar.removeAction("view.toggle_pbr")});var ge=e=>{let a=Math.max(-2,Math.min(2,e));Preview.all.forEach(t=>{t.renderer.toneMappingExposure=a}),Preview.selected.renderer.toneMappingExposure=a};w.push(()=>{o.exposureSlider=new NumSlider("display_settings_exposure",{category:"preview",name:"Exposure",description:"Adjusts the exposure of the scene",type:"number",value:1,icon:"exposure",settings:{min:-2,max:2,step:.01,default:1},onBefore(){Number(o.tonemappingSelect?.get())===M.NoToneMapping&&o.tonemappingSelect.change(M.LinearToneMapping.toString()),o.togglePbr?.set(!0)},onChange(e){ge(Number(e))},onAfter(){B()}}),o.resetExposureButton=new Action("display_settings_reset_exposure",{category:"preview",name:"Reset Exposure",description:"Resets the exposure of the scene",icon:"exposure_plus_1",condition:()=>o.exposureSlider!==void 0&&Number(o.exposureSlider?.get())!==1,click(){ge(1),o.exposureSlider?.setValue(1,!0),B()}}),o.tonemappingSelect=new BarSelect("display_settings_tone_mapping",{category:"preview",name:"Tone Mapping",description:"Changes the tone mapping of the preview",type:"select",default_value:M.NoToneMapping,value:Preview.selected.renderer.toneMapping??M.NoToneMapping,icon:"monochrome_photos",options:{[M.NoToneMapping]:"No Tone Mapping",[M.LinearToneMapping]:"Linear",[M.ReinhardToneMapping]:"Reinhard",[M.CineonToneMapping]:"Cineon",[M.NeutralToneMapping]:"Neutral",[M.ACESFilmicToneMapping]:"ACES"},onChange({value:e}){Preview.selected.renderer.toneMapping=Number(e);let a=1;Preview.selected.renderer.toneMapping===M.NoToneMapping?o.exposureSlider?.setValue(a,!0):a=Number(o.exposureSlider?.get()??1),Preview.all.forEach(t=>{t.renderer.toneMapping=Number(e),t.renderer.toneMappingExposure=a}),Preview.selected.renderer.toneMappingExposure=a,Blockbench.showQuickMessage(`Tone mapping set to ${this.getNameFor(e)}`,2e3),o.togglePbr&&!o.togglePbr.value&&o.togglePbr.set(!0),R()}})});var Y=class{async parse(a){let t=new ne,r="model.usda";t.file(r,"");let n=Me(),i={},s={};a.traverseVisible(h=>{if(!h.isMesh)return;let m=h;if(!m.material.isMeshStandardMaterial){console.warn("THREE.USDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)",h);return}let u=m.geometry,b=m.material,d="geometries/Geometry_"+u.id+".usd";if(!t.file(d)){let f=Ye(u);t.file(d,We(f))}b.uuid in i||(i[b.uuid]=b),n+=qe(m,u,b)}),n+=rt(i,s),t.file(r,n),n=null;for(let h in s){let m=s[h],u=h.split("_")[1],b=m.format===M.RGBAFormat,d=Ze(m.image,u),c=await(await new Promise(x=>d.toBlob(v=>v&&x(v),b?"image/png":"image/jpeg",1))).arrayBuffer();t.file(`textures/Texture_${h}.${b?"png":"jpg"}`,c)}let l=0;t.forEach(async h=>{let m=34+h.length;l+=m;let u=l&63,b=await t.file(h).async("uint8array");if(u!==4){let d=64-u,f=new Uint8Array(d),c=new Uint8Array(b.length+d);c.set(b,0),c.set(f,b.length),t.file(h,c)}l+=b.length});let g=await t.generateAsync({type:"blob",compression:"STORE"});return new Uint8Array(await g.arrayBuffer())}};function Ze(e,a){if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&e instanceof ImageBitmap){let t=1024/Math.max(e.width,e.height),r=document.createElement("canvas");r.width=e.width*Math.min(1,t),r.height=e.height*Math.min(1,t);let n=r.getContext("2d");if(n.imageSmoothingEnabled=!1,n.drawImage(e,0,0,r.width,r.height),a!==void 0){let i=parseInt(a,16),s=(i>>16&255)/255,l=(i>>8&255)/255,g=(i&255)/255,h=n.getImageData(0,0,r.width,r.height),m=h.data;for(let u=0;u<m.length;u+=4)m[u+0]=m[u+0]*s,m[u+1]=m[u+1]*l,m[u+2]=m[u+2]*g;n.putImageData(h,0,0)}return r}throw new Error("Unsupported image type")}var $=7;function Me(){return`#usda 1.0
(
    customLayerData = {
        string creator = "Blockbench USDZExporter"
    }
    metersPerUnit = 1
    upAxis = "Y"
)

`}function We(e){let a=Me();return a+=e,a}function qe(e,a,t){let r="Object_"+e.id,n=Xe(e.matrixWorld);return e.matrixWorld.determinant()<0&&console.warn("THREE.USDZExporter: USDZ does not support negative scales",e),`def Xform "${r}" (
    prepend references = @./geometries/Geometry_${a.id}.usd@</Geometry>
)
{
    matrix4d xformOp:transform = ${n}
    uniform token[] xformOpOrder = ["xformOp:transform"]

    rel material:binding = </Materials/Material_${t.id}>
}

`}function Xe(e){let a=e.elements;return`( ${G(a,0)}, ${G(a,4)}, ${G(a,8)}, ${G(a,12)} )`}function G(e,a){return`(${e[a+0]}, ${e[a+1]}, ${e[a+2]}, ${e[a+3]})`}function Ye(e){return`
def "Geometry"
{
  ${Ke(e)}
}
`}function Ke(e){let a="Geometry",t=e.attributes,r=t.position.count;return`
    def Mesh "${a}"
    {
        int[] faceVertexCounts = [${et(e)}]
        int[] faceVertexIndices = [${tt(e)}]
        normal3f[] normals = [${fe(t.normal,r)}] (
            interpolation = "vertex"
        )
        point3f[] points = [${fe(t.position,r)}]
        float2[] primvars:st = [${at(t.uv,r)}] (
            interpolation = "vertex"
        )
        uniform token subdivisionScheme = "none"
    }
`}function et(e){let a=e.index!==null?e.index.count:e.attributes.position.count;return Array(a/3).fill(3).join(", ")}function tt(e){let a=e.index,t=[];if(a!==null)for(let r=0;r<a.count;r++)t.push(a.getX(r));else{let r=e.attributes.position.count;for(let n=0;n<r;n++)t.push(n)}return t.join(", ")}function fe(e,a){if(e===void 0)return console.warn("USDZExporter: Normals missing."),Array(a).fill("(0, 0, 0)").join(", ");let t=[];for(let r=0;r<e.count;r++){let n=e.getX(r),i=e.getY(r),s=e.getZ(r);t.push(`(${n.toPrecision($)}, ${i.toPrecision($)}, ${s.toPrecision($)})`)}return t.join(", ")}function at(e,a){if(e===void 0)return console.warn("USDZExporter: UVs missing."),Array(a).fill("(0, 0)").join(", ");let t=[];for(let r=0;r<e.count;r++){let n=e.getX(r),i=e.getY(r);t.push(`(${n.toPrecision($)}, ${Number(i.toPrecision($))})`)}return t.join(", ")}function rt(e,a){let t=[];for(let r in e){let n=e[r];t.push(nt(n,a))}return`def "Materials"
{
${t.join("")}
}

`}function nt(e,a){let t="            ",r=[],n=[];function i(l,g,h){let m=l.id+(h?"_"+h.getHexString():""),u=l.format===M.RGBAFormat;return a[m]=l,`
        def Shader "Transform2d_${g}" (
            sdrMetadata = {
                string role = "math"
            }
        )
        {
            uniform token info:id = "UsdTransform2d"
            float2 inputs:in.connect = </Materials/Material_${e.id}/uvReader_st.outputs:result>
            float2 inputs:scale = ${be(l.repeat)}
            float2 inputs:translation = ${be(l.offset)}
            float2 outputs:result
        }

        def Shader "Texture_${l.id}_${g}"
        {
            uniform token info:id = "UsdUVTexture"
            asset inputs:file = @textures/Texture_${m}.${u?"png":"jpg"}@
            float2 inputs:st.connect = </Materials/Material_${e.id}/Transform2d_${g}.outputs:result>
            token inputs:wrapS = "repeat"
            token inputs:wrapT = "repeat"
            float outputs:r
            float outputs:g
            float outputs:b
            float3 outputs:rgb
        }`}let s=e;if(s.map!==null?(r.push(`${t}color3f inputs:diffuseColor.connect = </Materials/Material_${s.id}/Texture_${s.map.id}_diffuse.outputs:rgb>`),n.push(i(s.map,"diffuse",s.color))):r.push(`${t}color3f inputs:diffuseColor = ${xe(s.color)}`),s.emissiveMap!==null?(r.push(`${t}color3f inputs:emissiveColor.connect = </Materials/Material_${s.id}/Texture_${s.emissiveMap.id}_emissive.outputs:rgb>`),n.push(i(s.emissiveMap,"emissive"))):s.emissive.getHex()>0&&r.push(`${t}color3f inputs:emissiveColor = ${xe(s.emissive)}`),s.normalMap!==null&&(r.push(`${t}normal3f inputs:normal.connect = </Materials/Material_${s.id}/Texture_${s.normalMap.id}_normal.outputs:rgb>`),n.push(i(s.normalMap,"normal"))),s.aoMap!==null&&(r.push(`${t}float inputs:occlusion.connect = </Materials/Material_${s.id}/Texture_${s.aoMap.id}_occlusion.outputs:r>`),n.push(i(s.aoMap,"occlusion"))),s.roughnessMap!==null&&s.roughness===1?(r.push(`${t}float inputs:roughness.connect = </Materials/Material_${s.id}/Texture_${s.roughnessMap.id}_roughness.outputs:g>`),n.push(i(s.roughnessMap,"roughness"))):r.push(`${t}float inputs:roughness = ${s.roughness}`),s.metalnessMap!==null&&s.metalness===1?(r.push(`${t}float inputs:metallic.connect = </Materials/Material_${s.id}/Texture_${s.metalnessMap.id}_metallic.outputs:b>`),n.push(i(s.metalnessMap,"metallic"))):r.push(`${t}float inputs:metallic = ${s.metalness}`),s.alphaMap!==null?(r.push(`${t}float inputs:opacity.connect = </Materials/Material_${s.id}/Texture_${s.alphaMap.id}_opacity.outputs:r>`),r.push(`${t}float inputs:opacityThreshold = 0.0001`),n.push(i(s.alphaMap,"opacity"))):r.push(`${t}float inputs:opacity = ${s.opacity}`),s.isMeshPhysicalMaterial){let l=s;r.push(`${t}float inputs:clearcoat = ${l.clearcoat}`),r.push(`${t}float inputs:clearcoatRoughness = ${l.clearcoatRoughness}`),r.push(`${t}float inputs:ior = ${l.ior}`)}return`
    def Material "Material_${s.id}"
    {
        def Shader "PreviewSurface"
        {
            uniform token info:id = "UsdPreviewSurface"
${r.join(`
`)}
            int inputs:useSpecularWorkflow = 0
            token outputs:surface
        }

        token outputs:surface.connect = </Materials/Material_${s.id}/PreviewSurface.outputs:surface>
        token inputs:frame:stPrimvarName = "st"

        def Shader "uvReader_st"
        {
            uniform token info:id = "UsdPrimvarReader_float2"
            token inputs:varname.connect = </Materials/Material_${s.id}.inputs:frame:stPrimvarName>
            float2 inputs:fallback = (0.0, 0.0)
            float2 outputs:result
        }

${n.join(`
`)}

    }
`}function xe(e){return`(${e.r}, ${e.g}, ${e.b})`}function be(e){return`(${e.x}, ${e.y})`}var ve=Y;w.push(()=>{let e=new Codec("usdz",{extension:"usdz",name:"USDZ",remember:!0,export_options:{},fileName(){return I()+".usdz"},async compile(a={}){if(!Project)throw new Error("No project loaded");R();let t=Object.assign(this.getExportOptions(),a),r=new ve,n=new M.Scene;n.name="blockbench_export",n.add(Project.model_3d);let i=await r.parse(n);return this.dispatchEvent("compile",{model:i,options:t}),Canvas.scene.add(Project.model_3d),i},async export(){let a=await this.compile();Blockbench.export({content:a,name:this.fileName(),startpath:this.startPath(),resource_id:"usdz",type:this.name,extensions:["usdz"],savetype:"buffer"},t=>this.afterDownload(t))}});o.exportUsdz=new Action("export_usdz",{category:"file",name:"Export USDZ",description:"Exports the current model as a USDZ file",icon:"file_download",async click(){e&&await e.export()}}),o.usdz=e,MenuBar.addAction(o.exportUsdz,"file.export")});P.push(()=>{MenuBar.removeAction("file.export_usdz")});var V=class e{constructor({colors:a}){this._colors={...Object.fromEntries(Object.keys(p).map(t=>[t,p[t].default??new M.Color(4294967040)])),...a}}get colors(){return this._colors}set colors(a){this._colors={...this._colors,...a}}toString(){let a=Object.entries(this._colors).map(([t,r])=>[t,r.getHexString()]);return JSON.stringify(a)}getChannel(a){return this._colors[a]}static makeLinearColor(a){let t=Math.min(1,Math.max(0,a));return new M.Color(t,t,t).convertSRGBToLinear()}static fromSettings(){let a="#000000",t=Number(o.brushMetalnessSlider?.get()),r=Number(o.brushRoughnessSlider?.get()??1),n=(o.brushEmissiveColor?.get()??a).toString(),i=Number(o.brushHeightSlider?.get()),s=ColorPanel.get(),l={[p.albedo.id]:new M.Color(s),[p.metalness.id]:e.makeLinearColor(t),[p.roughness.id]:e.makeLinearColor(r),[p.emissive.id]:new M.Color(n??a),[p.height.id]:e.makeLinearColor(i),[p.normal.id]:p.normal.default??new M.Color("#8080ff")};return new e({colors:l})}};var _e="materialBrushPresets",K=()=>JSON.parse(localStorage.getItem(_e)||"{}"),st=(e,a)=>{let t=K(),r=a??guid(),n=o.userMaterialBrushPresets?.getFormResult()??{},i={};return n.albedo&&(i.albedo=n.albedo.toString()),n.metalness&&(i.metalness=Number(n.metalness)),n.roughness&&(i.roughness=Number(n.roughness)),n.emissive&&(i.emissive=n.emissive.toString()),n.height&&(i.height=Number(n.height)),t[r]=[i,e??"New Preset",U(i)],localStorage.setItem(_e,JSON.stringify(t)),r},ye=({metalness:e,roughness:a,emissive:t,height:r,albedo:n})=>{e!==void 0&&o.brushMetalnessSlider?.setValue(e||0,!0),a!==void 0&&o.brushRoughnessSlider?.setValue(a??1,!0),t!==void 0&&o.brushEmissiveColor?.set(t??"#000000"),r!==void 0&&o.brushHeightSlider?.setValue(Math.max(0,Math.min(1,r??.5)),!0),n!==void 0&&ColorPanel.set(n)},Q=({id:e})=>Condition({project:!0,tools:["material_brush"],method(){let a=S();return(a?.layers_enabled&&a.layers.find(({channel:t})=>t&&t===e)!==void 0)===!0}}),ot=re.extend({name:"UserPresetsDialog",data(){return{userPresets:{},channels:p}},methods:{applyPreset(e){try{let[a,t]=this.userPresets[e],{metalness:r,roughness:n,emissive:i,height:s,albedo:l}=a;ye({metalness:Number(r),roughness:Number(n),emissive:i.toString(),height:Number(s),albedo:l.toString()}),o.userMaterialBrushPresets?.hide(),Blockbench.showQuickMessage(`Preset "${t}" applied`,2e3)}catch{Blockbench.showQuickMessage("Failed to apply preset",2e3)}},deletePreset(e){Blockbench.showMessageBox({title:"Delete Preset",message:"Are you sure you want to delete this preset?",confirm:1,cancel:0,buttons:["Cancel","Delete"],checkboxes:{},width:400},a=>{if(a){let t=K(),r=this.userPresets[e][1]??e;delete t[e],localStorage.setItem("materialBrushPresets",JSON.stringify(t)),this.userPresets=t,Blockbench.showQuickMessage(`Preset "${r}" deleted`,2e3)}})},editPreset(e){o.userMaterialBrushPresets?.setFormValues({name:this.userPresets[e][1]??e,...this.userPresets[e][0]})},getSummary(e){return Object.entries(e).filter(([a])=>a in this.channels).map(([a,t])=>a==="albedo"||a==="emissive"?`${this.channels[a]?.label??a}: ${t}`:`${this.channels[a]?.label??a}: ${Number(t).toFixed(1)}`).join(`
`)}},computed:{presets(){return Object.entries(this.userPresets)}},mounted(){this.userPresets=K()},template:`
    <div>
      <ul class="list mobile_scrollbar preset_list">
        <li
          v-for="([key, [settings, name, image]]) in presets"
          :key="key"
          class="user_preset"
        >
          <div v-if="image" class="preset_preview" @click="editPreset(key)">
            <img :src="image" :alt="name" :title="getSummary(settings)" width="96" height="96" />
            <div class="preset_title">{{ name }}</div>
          </div>
          <div v-else>
            <div class="preset_title" @click="editPreset(key)" :title="getSummary(settings)">{{ name }}</div>
          </div>
          <div class="preset_buttons">
            <button class="delete_preset" type="button" @click="deletePreset(key)">
              <i class="material-icons">close</i>
            </button>
          </div>
        </li>
      </ul>
    </div>`});w.push(()=>{o.materialBrushStyles=Blockbench.addCSS(`
  .preset_list {
    display: grid;
    grid-template-columns: repeat(auto-fill, 96px);
    grid-gap: 8px;
    justify-content: start;
    align-items: start;
    margin: 0 auto;
    padding: 8px;
  }

  .user_preset {
    display: flex;
    justify-content: start;
    align-items: center;
    width: 100%;
    padding: 8px;
    position: relative;
  }

  .preset_title {
    font-size: 1em;
    color: var(--color-text);
  }

  .user_preset:hover .preset_title {
    color: var(--color-accent);
  }

  .preset_preview {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  .preset_buttons {
    display: flex;
    flex-direction: row;
    align-items: center;
    font-size: 0.8em;
    padding: 0 4px;
  }

  .preset_channel {
    display: flex;
    flex-direction: row;
    align-items: center;
    margin: 0 8px;
    font-size: 0.8em;
  }

  .delete_preset {
    margin-left: 8px;
    padding: 4px;
    height: 24px;
    width: 24px;
    min-width: 24px;
    background-color: transparent;
    color: var(--color-text);
    border: none;
    border-radius: 100%;
    position: absolute;
    right: -8px;
    top: 0;
    filter: drop-shadow(0 0 2px var(--color-shadow));
  }

  .delete_preset:hover {
    background: transparent;
    color: var(--color-accent);
  }

  .delete_preset .material-icons {
    font-size: 0.825em;
  }

  .delete_preset:hover .material-icons {
    color: var(--color-accent);
  }`),o.brushMetalnessSlider=new NumSlider("slider_brush_metalness",{category:"paint",name:"Metalness",description:"Adjust the metalness of the brush",tool_setting:"brush_metalness",settings:{min:0,max:1,step:.01,default:0},condition:()=>Q(p.metalness)}),o.brushRoughnessSlider=new NumSlider("slider_brush_roughness",{category:"paint",name:"Roughness",description:"Adjust the roughness of the brush",tool_setting:"brush_roughness",settings:{min:0,max:1,step:.01,default:1},condition:()=>Q(p.roughness)}),o.brushEmissiveColor=new ColorPicker("brush_emissive_color",{category:"paint",name:"Emissive",description:"Adjust the emissive color of the brush",value:"#000000",tool_setting:"brush_emissive",condition:()=>Q(p.emissive)}),o.brushHeightSlider=new NumSlider("slider_brush_height",{category:"paint",name:"Height",description:"Adjust the height of the brush",tool_setting:"brush_height",settings:{min:0,max:1,step:.01,default:.5},condition:()=>Q(p.height)}),o.materialBrushTool=new Tool("material_brush",{name:"Material Brush",description:"Paints across multiple texture layers",icon:"view_in_ar",paintTool:!0,cursor:"cell",category:"tools",toolbar:"brush",condition:{project:!0,selected:{texture:!0},modes:["paint"],method(){return S()?.layers_enabled??!1}},allowed_view_modes:"textured",tool_settings:{brush_metalness:0,brush_roughness:1,brush_emissive:"#000000",brush_height:.5},brush:{blend_modes:!1,shapes:!0,size:!0,softness:!0,opacity:!0,offset_even_radius:!0,floor_coordinates:!0,changePixel(e,a,t,r,{size:n,softness:i,texture:s,x:l,y:g}){let h=V.fromSettings(),m=Object.keys(h.colors),u=Math.floor(n-i*n/100),b=t;return s.layers.forEach(d=>{if(!d.visible||!m.includes(d.channel))return;let f=h.getChannel(d.channel);if(!f)return;let c=Math.sqrt((l-e)**2+(g-a)**2),x=Math.min(1,c/u);if(l%u<=x&&g%u<=x){let v=d.ctx.getImageData(e,a,1,1).data,_=new M.Color(`rgb(${v[0]}, ${v[1]}, ${v[2]})`);f.lerp(_,1)}d.ctx.fillStyle=f.getStyle(),d.ctx.fillRect(e,a,1,1),d.selected&&(b={r:f.r*255,g:f.g*255,b:f.b*255,a:r*255})}),b}},onCanvasClick(e){Painter.startPaintToolCanvas(e,e.event)},onSelect(){Painter.updateNslideValues(),R()},click(){B()}}),o.loadBrushPreset=new Action("load_brush_preset",{icon:"stroke_full",name:"Material Brush Presets",description:"Load or save a brush preset",category:"paint",condition:{project:!0},click(){o.userMaterialBrushPresets=new Dialog("user_brush_presets",{id:"user_brush_presets",title:"Edit Material Brush",component:ot,part_order:["lines","component","form"],form:{albedo:{type:"color",label:"Albedo",value:ColorPanel.get(),toggle_enabled:!0},metalness:{type:"number",label:"Metalness",min:0,max:1,step:.01,full_width:!1,toggle_enabled:!0},roughness:{type:"number",label:"Roughness",min:0,max:1,step:.01,toggle_enabled:!0,full_width:!1},emissive:{type:"color",label:"Emissive",value:"#000000",toggle_enabled:!0},height:{type:"number",label:"Height",min:0,max:1,step:.01,toggle_enabled:!0}},onConfirm(e){ye({metalness:Number(e.metalness??o.brushMetalnessSlider?.get()),roughness:Number(e.roughness??o.brushRoughnessSlider?.get()),emissive:(e.emissive??o.brushEmissiveColor?.get()).toString(),height:Number(e.height??o.brushHeightSlider?.get()),albedo:(e.albedo??ColorPanel.get()).toString()})},buttons:["Close","Save","Apply"],cancelIndex:0,confirmIndex:2,onButton(e,a){o.materialBrushTool?.select(),e===1&&Blockbench.textPrompt("Save Preset","New Preset",t=>{t&&(st(t),Blockbench.showQuickMessage(`Preset "${t}" saved`,2e3))})}}).show()}}),MenuBar.addAction(o.materialBrushTool,"tools.0")});P.push(()=>{MenuBar.removeAction("tools.material_brush")});w.push(()=>{o.materialBrushPanel=new Panel("material_brush_panel",{name:"Material Brush",id:"material_brush_panel",icon:"view_in_ar",toolbars:[new Toolbar("material_brush_toolbar",{id:"material_brush_toolbar",children:["material_brush","load_brush_preset","slider_brush_metalness","slider_brush_roughness","brush_emissive_color","slider_brush_height"],name:"Material Settings"})],condition:{modes:["paint"],project:!0},component:{},expand_button:!0,growable:!1,onFold(){},onResize(){},default_side:"right",default_position:{slot:"right_bar",float_position:[0,0],float_size:[400,300],height:300,folded:!1},insert_after:"color",insert_before:"outliner"})});w.push(()=>{o.displaySettingsPanel=new Panel("display_settings",{name:"PBR Controls",id:"display_settings_panel",icon:"display_settings",toolbars:[new Toolbar("controls_toolbar",{id:"controls_toolbar",children:["toggle_pbr","correct_lights","display_settings_tone_mapping","display_settings_exposure","display_settings_reset_exposure","show_channel_select_menu"],name:"Display Settings"})],display_condition:{modes:["edit","paint","animate"],project:!0},component:{},expand_button:!0,growable:!1,onFold(){},onResize(){},default_side:"left",default_position:{slot:"left_bar",float_position:[0,0],float_size:[400,300],height:300,folded:!1},insert_after:"textures",insert_before:"color"})});(()=>{let e=()=>{w.forEach(t=>t())},a=()=>{z(),P.forEach(t=>t()),Object.entries(o).forEach(([t,r])=>{try{r?.delete()}catch(n){console.warn(`Failed to delete ${t} action:`,n)}})};BBPlugin.register("pbr_preview",{version:"1.1.0",title:"PBR Tools",author:"Jason J. Gardner",description:"Create and view PBR materials in Blockbench. Export textures for Java and RenderDragon shaders.",tags:["Minecraft: Java Edition","Minecraft: Bedrock Edition","PBR"],icon:"icon.png",variant:"both",await_loading:!0,repository:"https://github.com/jasonjgardner/blockbench-plugins",has_changelog:!0,min_version:"4.10.3",onload:e,onunload:a})})();})();
