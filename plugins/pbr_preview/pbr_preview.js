"use strict";(()=>{var v=THREE,re=Vue,ne=window.JSZip;var B="_NONE_",g={albedo:{id:"albedo",label:"Albedo",description:"The color of the material",map:"map",icon:"tonality",default:new v.Color(16777215),regex:new RegExp("(s|_)*(basecolor|color|albedo)","i")},metalness:{id:"metalness",label:"Metalness",description:"The material's metalness map",map:"metalnessMap",icon:"brightness_6",default:new v.Color(0),regex:new RegExp("[ _]*metal(lic|ness)?","i")},emissive:{id:"emissive",label:"Emissive",description:"The material's emissive map",map:"emissiveMap",icon:"wb_twilight",default:new v.Color(0),regex:new RegExp("[ _]*(emissive|emission)","i")},roughness:{id:"roughness",label:"Roughness",description:"The material's roughness map",map:"roughnessMap",icon:"grain",default:new v.Color(16777215),regex:new RegExp("[ _]*rough(ness)?","i")},height:{id:"height",label:"Height",description:"The material's height map",map:"bumpMap",icon:"landscape",default:new v.Color(16777215),regex:new RegExp("[ _]*(height|bump)","i")},normal:{id:"normal",label:"Normal",description:"The material's normal map",map:"normalMap",icon:"looks",default:new v.Color("rgb(128, 128, 255)"),regex:new RegExp("[ _]*normal","i")},ao:{id:"ao",label:"Ambient Occlusion",description:"The material's ambient occlusion map",map:"aoMap",icon:"motion_mode",default:new v.Color(16777215),regex:new RegExp("[ _]*(ao|ambientocclusion|ambient occlusion)","i")}},o={},y=[],C=[];var se=[...Object.keys(g).map(e=>g[e].id),B];y.push(()=>{o.channelProp=new Property(TextureLayer,"enum","channel",{default:B,values:se,label:"PBR Channel",exposed:!1}),o.textureChannelProp=new Property(Texture,"enum","channel",{default:B,values:se,label:"PBR Channel",exposed:!1}),o.materialTextureProp=new Property(Texture,"boolean","material",{default:!1,label:"Material Texture"}),o.pbrMaterialsProp=new Property(ModelProject,"object","pbr_materials",{default:{},exposed:!1,label:"PBR Materials"}),o.projectMaterialsProp=new Property(ModelProject,"object","bb_materials",{default:{},exposed:!1,label:"Project Materials"}),o.projectPbrModeProp=new Property(ModelProject,"boolean","pbr_active",{default:!1,exposed:!1,values:[],label:"PBR Mode"})});function k(){return Texture.selected?Texture.selected:TextureLayer.selected?TextureLayer.selected.texture:Project?Project.selected_texture?Project.selected_texture:Project.textures.find(e=>e.selected)??null:Texture.all.find(e=>e.selected)??Texture.getDefault()}function A(){return TextureLayer.selected?TextureLayer.selected:Texture.selected?.selected_layer?Texture.selected.selected_layer:Project.selected_texture!==null&&Project.selected_texture?.layers_enabled===!0?Project.selected_texture.layers.find(e=>e.selected)??Project.selected_texture.layers[0]:k()?.getActiveLayer()??null}function $(){return Project?Project.model_identifier.length>0?Project.model_identifier:Project.getDisplayName():pathToName(k()?.name??"texture")}function oe(e,a){let t;return function(...r){let n=()=>{t=void 0,e.apply(this,r)};clearTimeout(t),t=setTimeout(n,a)}}function U(e){let a=MediaPreview.renderer??new v.WebGLRenderer({alpha:!0,antialias:!0}),t=new v.Scene,r=new v.PerspectiveCamera(75,96/96,.1,1e3),n=new v.AmbientLight(16777215,.75);t.add(n);let i=new v.PointLight(16777215,1,100);i.position.set(5,5,5),t.add(i);let s=new v.SphereGeometry(1,32,32),l=e instanceof v.MeshStandardMaterial&&e.isMeshStandardMaterial?e:new v.MeshStandardMaterial({color:e.albedo,metalness:e.metalness??0,roughness:e.roughness??1,emissive:e.emissive,bumpScale:e.height??0,envMap:PreviewScene.active?.cubemap??null,envMapIntensity:.5}),m=new v.Mesh(s,l);t.add(m),r.position.x=0,r.position.y=0,r.position.z=2,a.setSize(96,96),a.render(t,r);let h=a.domElement.toDataURL();return l.dispose(),MediaPreview.renderer||(a.clear(),a.dispose()),h}function Z(e,a){let t=a??document.createElement("canvas"),r=t.getContext("2d");if(!r)return t.remove(),null;let n=Math.max(Project?Project.texture_width:16,16),i=Math.max(Project?Project.texture_height:16,16);t.width=n,t.height=i,r.fillStyle=`rgb(${e.r*255}, ${e.g*255}, ${e.b*255})`,r.fillRect(0,0,n,i);let s=t.toDataURL();return a||t.remove(),s}var Ge=(e=!0)=>{let a=Project?Project.textures??Texture.all:Texture.all;return e?a.filter(t=>t.layers_enabled&&t.layers.length>0).flatMap(t=>t.layers):a},j=class e{constructor(a,t){this._scope=a??Ge(),this._materialUuid=t}merToCanvas(){let a=this.getTexture(g.emissive),t=this.getTexture(g.roughness),r=this.getTexture(g.metalness);if(!a&&!t&&!r){let{metalness:n,emissive:i,roughness:s}=this.decodeMer();n&&(r=e.makePixelatedCanvas(n)),i&&(a=e.makePixelatedCanvas(i)),s&&(t=e.makePixelatedCanvas(s))}return{emissiveMap:a,roughnessMap:t,metalnessMap:r}}getMaterial(a={}){let{emissiveMap:t,roughnessMap:r,metalnessMap:n}=Format.id.startsWith("bedrock")?this.merToCanvas():{emissiveMap:this.getTexture(g.emissive),roughnessMap:this.getTexture(g.roughness),metalnessMap:this.getTexture(g.metalness)},i=this.getTexture(g.normal);return new v.MeshStandardMaterial({map:this.getTexture(g.albedo)??e.makePixelatedCanvas(TextureLayer.selected?.canvas??Texture.all.find(s=>s.selected)?.canvas??Texture.getDefault().canvas),aoMap:this.getTexture(g.ao),bumpMap:this.getTexture(g.height),normalMap:i,normalScale:new v.Vector2(-1,1),metalnessMap:n,metalness:n?1:0,roughnessMap:r,roughness:1,emissiveMap:t,emissiveIntensity:t?1:0,emissive:t?16777215:0,envMap:PreviewScene.active?.cubemap??null,envMapIntensity:.95,alphaTest:.1,transparent:!0,...a})}renderMaterialPreview(){return U(this.getMaterial())}saveTexture(a,t){Project&&(Project.pbr_materials||(Project.pbr_materials={}),Project.pbr_materials[this._materialUuid]||(Project.pbr_materials[this._materialUuid]={}),Project.pbr_materials[this._materialUuid][a.id]=t.uuid,t.extend({channel:a.id}))}findTexture(a,t=!0){if(!Project)return null;let r=this._scope.find(m=>m.channel&&(m.channel===a||m.channel===a.id));if(r)return r;let[n,i]=typeof a=="string"?[a,new RegExp(`_*${a}(.[^.]+)?$`,"i")]:[a.id,a.regex??new RegExp(`_*${a.id}(.[^.]+)?$`,"i")];Project.pbr_materials=Project.pbr_materials??{};let s=Project.pbr_materials[this._materialUuid];if(t&&!s?.length&&n!==B)return this._scope.find(m=>i.test(m.name))??null;let l=s?.[n];return l?this._scope.find(m=>m.uuid===l)??null:null}static makePixelatedCanvas(a){let t=new v.CanvasTexture(a,void 0,void 0,void 0,v.NearestFilter,v.NearestFilter);return t.needsUpdate=!0,t}getTexture(a){let t=this.findTexture(a);return t?e.makePixelatedCanvas(t.canvas):null}static extractChannel(a,t){let r=a.canvas,{width:n,height:i}=r,s=r.getContext("2d");if(!s||!n||!i)return null;let l=document.createElement("canvas");l.width=n,l.height=i;let m=l.getContext("2d");if(!m)return null;let h={r:0,g:1,b:2,a:3}[t],{data:d}=s.getImageData(0,0,n,i),u=new Uint8ClampedArray(n*i*4);for(let p=0;p<d.length;p+=4){let f=d[p+h];u[p]=f,u[p+1]=f,u[p+2]=f,u[p+3]=255}let b=new ImageData(u,n,i);return m.putImageData(b,0,0),l}decodeMer(a=1){let t=this.findTexture("mer",!0);if(!t)return{metalness:null,emissive:null,emissiveLevel:null,roughness:null,sss:null};let r=e.extractChannel(t,"r"),n=e.extractChannel(t,"g"),i=e.extractChannel(t,"b"),s=e.extractChannel(t,"a"),l=document.createElement("canvas");l.width=t.img.width??16,l.height=t.img.height??16;let m=this.findTexture(g.albedo);m&&(l.width=m.img.width??16,l.height=m.img.height??16);let h=l.getContext("2d"),d=n?.getContext("2d"),u=m?.canvas?.getContext("2d");if(!h||!u||!d)return{metalness:r,emissive:n,roughness:i,sss:s};let b=u.getImageData(0,0,l.width,l.height),p=d.getImageData(0,0,l.width,l.height),f=new Uint8ClampedArray(l.width*l.height*4);for(let c=0;c<b.data.length;c+=4){if(p.data[c]>a){f[c]=b.data[c],f[c+1]=b.data[c+1],f[c+2]=b.data[c+2],f[c+3]=255;continue}f[c]=0,f[c+1]=0,f[c+2]=0,f[c+3]=255}return h.putImageData(new ImageData(f,l.width,l.height),0,0),{metalness:r,emissive:l,emissiveLevel:n,roughness:i,sss:s}}createMer(a=!1){let t=this.findTexture(g.metalness,a),r=this.findTexture(g.emissive,a),n=this.findTexture(g.roughness,a),i=this.findTexture("sss",!1),s=Math.max(t?.img.width??0,r?.img.width??0,n?.img.width??0,Project?Project.texture_width:0,16),l=Math.max(t?.img.height??0,r?.img.height??0,n?.img.height??0,Project?Project.texture_height:0,16),m=document.createElement("canvas");m.width=s,m.height=l;let h=m.getContext("2d");if(!h)return null;let d=t?.img?e.extractChannel(t,"r"):null,u=r?.img?e.extractChannel(r,"g"):null,b=n?.img?e.extractChannel(n,"b"):null,p=i&&i?.img?e.extractChannel(i,"a"):null,f=d?.getContext("2d")?.getImageData(0,0,s,l)??new ImageData(s,l),c=u?.getContext("2d")?.getImageData(0,0,s,l)??new ImageData(s,l),x=b?.getContext("2d")?.getImageData(0,0,s,l)??new ImageData(s,l),_=p?.getContext("2d")?.getImageData(0,0,s,l)??new ImageData(new Uint8ClampedArray(s*l*4).fill(255),s,l),M=new Uint8ClampedArray(s*l*4);for(let w=0;w<M.length;w+=4)M[w]=f.data[w],M[w+1]=c.data[w],M[w+2]=x.data[w],M[w+3]=_.data[w];return h.putImageData(new ImageData(M,s,l),0,0),m}createLabPbrOutput(a=!0){let t=this.findTexture(g.metalness,a),r=this.findTexture(g.emissive,a),n=this.findTexture(g.roughness,a),i=this.findTexture(g.normal,a),s=this.findTexture(g.height,a),l=this.findTexture(g.ao,!1),m=this.findTexture("sss",!0),h=this.findTexture("porosity",!0),d=Math.max(t?.img.width??0,r?.img.width??0,n?.img.width??0,Project?Project.texture_width:0,16),u=Math.max(t?.img.height??0,r?.img.height??0,n?.img.height??0,Project?Project.texture_height:0,16),b=document.createElement("canvas");b.width=d,b.height=u;let p=b.getContext("2d"),f=document.createElement("canvas");f.width=d,f.height=u;let c=f.getContext("2d");if(!p||!c)return null;let x=new Uint8ClampedArray(d*u*4),_=new Uint8ClampedArray(d*u*4),M=t?.canvas,w=r?.canvas,D=n?.canvas,T=m?.canvas,L=h?.canvas,E=M?.getContext("2d"),S=w?.getContext("2d"),Ee=D?.getContext("2d"),Pe=T?.getContext("2d"),Le=L?.getContext("2d"),ke=E?.getImageData(0,0,d,u),I=S?.getImageData(0,0,d,u),ee=Ee?.getImageData(0,0,d,u),je=Pe?.getImageData(0,0,d,u),Se=Le?.getImageData(0,0,d,u);for(let P=0;P<x.length;P+=4){let ae=ee?1-Math.sqrt(ee.data[P]/255):0,Ue=Math.min(229,Math.max(0,Math.round((ke?.data[P]??ae)*229))),Oe=Se?.data[P],Fe=je?.data[P];if(x[P]=ae*255,x[P+1]=Ue,x[P+2]=Fe??Oe??0,!I){x[P+3]=255;continue}let ze=Math.round((I?.data[P]+I?.data[P+1]+I?.data[P+2])/3);x[P+3]=ze||255}p.putImageData(new ImageData(x,d,u),0,0);let De=i?.canvas,Re=l?.canvas,Be=s?.canvas,Ae=De?.getContext("2d"),Ne=Re?.getContext("2d"),He=Be?.getContext("2d"),te=Ae?.getImageData(0,0,d,u),Ie=Ne?.getImageData(0,0,d,u),$e=He?.getImageData(0,0,d,u);for(let P=0;P<_.length;P+=4)_[P]=te?.data[P]??0,_[P+1]=te?.data[P+1]??0,_[P+2]=Ie?.data[P+2]??255,_[P+3]=$e?.data[P+3]||255;return c.putImageData(new ImageData(_,d,u),0,0),{specular:b,normalMap:f}}decodeLabPbrNormal(a){let t=a.img.width??16,r=a.img.height??16,n=a.canvas.getContext("2d");if(!n)return{};let i=document.createElement("canvas");i.width=t,i.height=r;let s=document.createElement("canvas");s.width=t,s.height=r;let l=document.createElement("canvas");l.width=t,l.height=r;let m=i.getContext("2d"),h=s.getContext("2d"),d=l.getContext("2d"),{data:u}=n.getImageData(0,0,t,r);if(!u||!m||!h||!d)return{};let b=new Uint8ClampedArray(t*r*4),p=new Uint8ClampedArray(t*r*4),f=new Uint8ClampedArray(t*r*4);for(let c=0;c<u.length;c+=4){let x=c+1,_=c+2,M=c+3;b[c]=u[_],b[x]=u[_],b[_]=u[_],b[M]=255,p[c]=u[c],p[x]=u[x],p[_]=255,p[M]=255,f[c]=u[M],f[x]=u[M],f[_]=u[M],f[M]=255}return m.putImageData(new ImageData(b,t,r),0,0),h.putImageData(new ImageData(p,t,r),0,0),d.putImageData(new ImageData(f,t,r),0,0),{ao:i,normal:s,heightmap:l}}decodeLabPbrSpecular(a){let t=a.img.width??16,r=a.img.height??16,n=a.canvas.getContext("2d");if(!n)return{};let i=document.createElement("canvas");i.width=t,i.height=r;let s=document.createElement("canvas");s.width=t,s.height=r;let l=document.createElement("canvas");l.width=t,l.height=r;let m=document.createElement("canvas");m.width=t,m.height=r;let h=document.createElement("canvas");h.width=t,h.height=r;let d=i.getContext("2d"),u=s.getContext("2d"),b=l.getContext("2d"),p=m.getContext("2d"),f=h.getContext("2d"),{data:c}=n.getImageData(0,0,t,r);if(!c||!d||!u||!b||!p||!f)return{};let x=new Uint8ClampedArray(t*r*4),_=new Uint8ClampedArray(t*r*4),M=new Uint8ClampedArray(t*r*4),w=new Uint8ClampedArray(t*r*4),D=new Uint8ClampedArray(t*r*4);for(let T=0;T<c.length;T+=4){let L=T+1,E=T+2,S=T+3;M[T]=255-c[T],M[L]=255-c[T],M[E]=255-c[T],M[S]=255,x[T]=c[L],x[L]=c[L],x[E]=c[L],x[S]=255,_[T]=c[S],_[L]=c[S],_[E]=c[S],_[S]=255,w[T]=0,w[L]=0,w[E]=0,w[S]=255,D[T]=c[E],D[L]=c[E],D[E]=c[E],D[S]=255,c[E]<65&&(w[T]=c[E],w[L]=c[E],w[E]=c[E],w[S]=255,D[T]=0,D[L]=0,D[E]=0,D[S]=255)}return d.putImageData(new ImageData(x,t,r),0,0),u.putImageData(new ImageData(_,t,r),0,0),b.putImageData(new ImageData(M,t,r),0,0),p.putImageData(new ImageData(w,t,r),0,0),f.putImageData(new ImageData(D,t,r),0,0),{metalness:i,emissive:s,roughness:l,sss:m,porosity:h}}createTexturesFromSpecular(a){let t=this.decodeLabPbrSpecular(a);return Object.entries(t).forEach(([r,n])=>{n&&new Texture({name:`${a.name}_${r}`,saved:!1,particle:!1,keep_size:!1}).fromDataURL(n.toDataURL()).add()}),t}createTexturesFromNormal(a){let t=this.decodeLabPbrNormal(a);return Object.entries(t).forEach(([r,n])=>{n&&new Texture({name:`${a.name}_${r}`,saved:!1,particle:!1,keep_size:!1}).fromDataURL(n.toDataURL()).add()}),t}};var O=class{constructor({lightHeight:a=.66,ambientLight:t=[.1,.1,.1],minLightIntensity:r=0,lightDiffuse:n=[1,1,1]}={}){this.lightHeight=a,this.ambientLight=t,this.minLightIntensity=r,this.lightDiffuse=n}bake(a,t,r){let n=t instanceof HTMLCanvasElement?t:this.createCanvas(t.width,t.height),i=r instanceof HTMLCanvasElement?r:this.createCanvas(r.width,r.height),s=n.getContext("2d"),l=i.getContext("2d");s.drawImage(t,0,0),l.drawImage(r,0,0);let m=s.getImageData(0,0,t.width,t.height),h=l.getImageData(0,0,r.width,r.height),d=[],u=[];for(let p=0;p<h.width;++p){u[p]=[];for(let f=0;f<h.height;++f){let c=(p+f*h.width)*4,x=[(h.data[c+0]/255-.5)*2,(h.data[c+1]/255-.5)*2,(h.data[c+2]/255-.5)*2],_=Math.sqrt(x[0]**2+x[1]**2+x[2]**2);u[p][f]=[x[0]/_,x[1]/_,x[2]/_]}}let b=p=>{let f=this.createCanvas(t.width,t.height),c=f.getContext("2d"),x=c.getImageData(0,0,f.width,f.height),_=[Math.cos(p),Math.sin(p),this.lightHeight];for(let M=0;M<h.width;++M)for(let w=0;w<h.height;++w){let D=u[M][w],T=(M+w*h.width)*4,L=[m.data[T+0]/255,m.data[T+1]/255,m.data[T+2]/255,m.data[T+3]],E=D[0]*_[0]+D[1]*_[1]+D[2]*_[2];E=Math.min(1,Math.max(this.minLightIntensity,E));let S=[E*L[0]*this.lightDiffuse[0]+this.ambientLight[0],E*L[1]*this.lightDiffuse[1]+this.ambientLight[1],E*L[2]*this.lightDiffuse[2]+this.ambientLight[2],L[3]];x.data[T+0]=Math.floor(S[0]*255),x.data[T+1]=Math.floor(S[1]*255),x.data[T+2]=Math.floor(S[2]*255),x.data[T+3]=S[3]}return c.putImageData(x,0,0),f};for(let p=0;p<a;++p){let f=Math.PI*2/a*p;d.push(b(f))}return d}createCanvas(a,t){let r=document.createElement("canvas");return r.width=a,r.height=t,r}};var ie=(e,a=8,t=!1)=>{if(!Project)return;let r=Project.selected_texture??Texture.getDefault(),n=new j(r.layers_enabled?r.layers:Project.textures,r.uuid),i=n.findTexture(g.albedo);if(!i){Blockbench.showStatusMessage("Can not bake without a base color assigned.",3e3);return}let s=n.findTexture(g.normal);if(!s){Blockbench.showStatusMessage("Can not bake without a normal map assigned.",3e3);return}let m=new O(e).bake(a,i.canvas,s.canvas),h=new Texture({name:`${i.name}_baked`,saved:!1,particle:!1,keep_size:!1,layers_enabled:!0}).fromDataURL(m[0].toDataURL()),d=t?u=>{let b=n.findTexture(g.emissive);if(!b)return u;let p=b.canvas;if(!p.getContext("2d"))return u;let c=Math.max(u.width,p.width,Project?Project.texture_width:16),x=Math.max(u.height,p.height,Project?Project.texture_height:16),_=document.createElement("canvas");_.width=c,_.height=x;let M=_.getContext("2d");return M?(M.drawImage(u,0,0),M.globalCompositeOperation="screen",M.drawImage(p,0,0),_):u}:u=>u;m.forEach((u,b)=>{new TextureLayer({name:`baked_${b+1}`,data_url:d(u).toDataURL()},h).addForEditing()}),h.add().select(),Blockbench.showQuickMessage("Textures baked \u{1F950}",2e3)};y.push(()=>{o.bakeTexturesDialog=new Dialog("bake_textures",{id:"bake_textures",title:"Bake Textures",buttons:["Bake","Cancel"],form:{ambientLight:{type:"color",label:"Ambient Light",value:"#1f1f1f"},lightDiffuse:{type:"color",label:"Light Diffuse",value:"#ffffff"},lightHeight:{type:"range",label:"Light Height",min:0,max:1,step:.01,value:.66},minLightIntensity:{type:"range",label:"Minimum Light Intensity",min:0,max:1,step:.01,value:0},directions:{type:"number",label:"Directions",value:8,min:1,max:360,step:1},blendEmissive:{type:"checkbox",label:"Blend Emissive",value:!1}},onConfirm(e){let a=new v.Color(e.ambientLight.toString()),t=new v.Color(e.lightDiffuse.toString());ie({ambientLight:[a.r,a.g,a.b],lightDiffuse:[t.r,t.g,t.b],lightHeight:Number(e.lightHeight),minLightIntensity:Number(e.minLightIntensity)},e.directions??8,e.blendEmissive??!1)}}),o.bakeTexturesAction=new Action("bake_textures",{icon:"cake",name:"Bake Textures",description:"Bakes textures for the selected PBR material",click(){o.bakeTexturesDialog?.show()}}),MenuBar.addAction(o.bakeTexturesAction,"tools")});C.push(()=>{MenuBar.removeAction("tools.bake_textures")});function le(e,a){let t=e.getTexture();if(!t||!Project)return null;let r=Project.materials[t.uuid];r.isShaderMaterial&&!Project.bb_materials[t.uuid]?Project.bb_materials[t.uuid]=r:r.isMeshStandardMaterial&&r.dispose();let n=new j(t.layers_enabled?t.layers.filter(i=>i.visible)??null:Project.textures,t.uuid).getMaterial({side:Canvas.getRenderSide(t),...a});return Project.materials[t.uuid]=v.ShaderMaterial.prototype.copy.call(n,r),t}function ce(e){return Object.values(e).filter(a=>a?(Canvas.updateAllFaces(a),!0):!1).length>0}function Ve(e,a){let t={};return e.forAllFaces(r=>{let n=le(r,a);n&&(t[n.uuid]=n)}),ce(t)}function Qe(e,a){let t={};return Object.keys(e.faces).forEach(r=>{let n=e.faces[r],i=le(n,a);i&&(t[i.uuid]=i)}),ce(t)}var R=(e={})=>{Project&&(Project.pbr_active=Texture.all.length>0&&Project.elements.map(a=>a instanceof Mesh&&Ve(a,e)||a instanceof Cube&&Qe(a,e)).filter(Boolean).length>0)},N=(e=100)=>oe(R,e);var q={},W=()=>Condition({modes:["edit","paint"],selected:{texture:!0},project:!0,method(){let e=k();return e&&!e.material?!0:e?.material===!0&&A()!==null&&Modes.paint}}),ue=()=>Condition({modes:["paint","edit"],selected:{texture:!0},method(){let e=k();if(e?.material&&Modes.edit)return!1;let a=A()??e;return a?.channel&&a.channel!==B}});y.push(()=>{Object.entries(g).forEach(([e,a])=>{q[e]=new Action(`assign_channel_${e}`,{icon:a.icon??"tv_options_edit_channels",name:`Assign to ${a.label.toLocaleLowerCase()} channel`,description:`Assign the selected layer to the ${a.label} channel`,category:"textures",condition:W,click(){let t=TextureLayer.selected??(Project?Project.selected_texture:null);if(!t)return;Undo.initEdit({layers:[t]}),t.extend({channel:a.id});let r=t instanceof TextureLayer?t.texture:t;r.updateChangesAfterEdit(),Project.pbr_materials[r.uuid]||(Project.pbr_materials[r.uuid]={}),Object.entries(Project.pbr_materials[r.uuid]).forEach(([n,i])=>{i===t.uuid&&(delete Project.pbr_materials[r.uuid][n],t.channel=B)}),r.uuid===t.uuid&&(Project.pbr_materials[r.uuid]={}),Project.pbr_materials[r.uuid][e]=t.uuid,Undo.finishEdit("Change channel assignment"),Blockbench.showQuickMessage(`Assigned "${t.name}" to ${a.label} channel`,2e3),R()}})})});C.push(()=>{Object.values(q).forEach(e=>{e.delete()})});y.push(()=>{o.unassignChannel=new Action("unassign_channel",{icon:"cancel",name:"Unassign Channel",description:"Unassign the selected layer from the channel",category:"textures",condition:ue,click(){let e=TextureLayer.selected??(Project?Project.selected_texture:null);if(!e)return;Undo.initEdit({layers:[e]});let a=e instanceof TextureLayer?e.texture:e,t=e.channel;Project.pbr_materials[a.uuid]={},e.channel=B,a.updateChangesAfterEdit(),Undo.finishEdit("Unassign channel"),Blockbench.showQuickMessage(`Unassigned "${e.name}" from ${t} channel`,2e3),N()}}),o.channelMenu=new Menu("channel_menu",[...Object.keys(g).map(e=>`assign_channel_${e}`),"unassign_channel"],{onOpen(){N()}}),o.openChannelMenu=new Action("pbr_channel_menu",{name:"Assign to PBR Channel",icon:"texture",condition:()=>W()||ue(),click(e){o.channelMenu?.open(e)},children:[...Object.values(q),o.unassignChannel]}),o.showChannelMenu=new Action("show_channel_menu",{icon:"texture",name:"Assign to PBR Channel",description:"Assign the selected layer to a channel",category:"textures",condition:W,click(e){o.channelMenu?.open(e)}}),o.openChannelMenu&&(MenuBar.addAction(o.openChannelMenu,"image.0"),Texture.prototype.menu.addAction(o.openChannelMenu,"0"),TextureLayer.prototype.menu.addAction(o.openChannelMenu,"0")),Toolbars.layers.add(o.showChannelMenu,1)});C.push(()=>{MenuBar.removeAction("image.pbr_channel_menu"),Texture.prototype.menu.removeAction("pbr_channel_menu"),TextureLayer.prototype.menu.removeAction("pbr_channel_menu"),Toolbars.layers.remove(o.showChannelMenu)});function X(e,a=!1){let t=e.canvas.getContext("2d");if(!t)return null;let r=Math.max(e.img.width??e.canvas.width,Project?Project.texture_width:0,16),n=Math.max(e.img.height??e.canvas.height,Project?Project.texture_height:0,16),{data:i}=t.getImageData(0,0,r,n),s=document.createElement("canvas"),l=s.getContext("2d");if(!l)return null;let m=(c,x)=>{let _=(c+x*r)*4;return i[_]/255};s.width=r,s.height=n,l.drawImage(e.img,0,0,r,n);let h=l.getImageData(0,0,r,n),d=h.data,u=c=>{let x=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return[c[0]/x,c[1]/x,c[2]/x]};for(let c=0;c<n;c++)for(let x=0;x<r;x++){let _=m(Math.max(x-1,0),c),M=m(Math.min(x+1,r-1),c),w=m(x,Math.max(c-1,0)),D=m(x,Math.min(c+1,n-1)),T=M-_,L=D-w,E=u([-T,-L,1]),S=(c*r+x)*4;d[S]=(E[0]+1)/2*255,d[S+1]=(E[1]+1)/2*255,d[S+2]=(E[2]+1)/2*255,d[S+3]=a?m(x,c)*255:255}l.putImageData(h,0,0);let b=s.toDataURL(),p=`${e.name.replace(/_height(map)?/i,"")}_normal`;if(e instanceof TextureLayer){let c=new TextureLayer({name:p,data_url:b,visible:!0},e.texture);return c.addForEditing(),c}let f=new Texture({name:p,saved:!1,particle:!1}).fromDataURL(b);return Project&&f.add(),f}function me(e){let a=e.canvas.getContext("2d");if(!a)return null;let t=Math.max(e.img.width??e.canvas.width,Project?Project.texture_width:0,16),r=Math.max(e.img.height??e.canvas.height,Project?Project.texture_height:0,16),{data:n}=a.getImageData(0,0,t,r),i=document.createElement("canvas"),s=i.getContext("2d");if(!s)return null;let l=(p,f)=>{let c=(p+f*t)*4;return n[c]/255};i.width=t,i.height=r,s.drawImage(e.img,0,0,t,r);let m=s.getImageData(0,0,t,r),h=m.data;for(let p=0;p<r;p++)for(let f=0;f<t;f++){let c=l(Math.max(f-1,0),p),x=l(Math.min(f+1,t-1),p),_=l(f,Math.max(p-1,0)),M=l(f,Math.min(p+1,r-1)),w=x-c,D=M-_,T=Math.sqrt(w*w+D*D)*255,L=(p*t+f)*4;h[L]=T,h[L+1]=T,h[L+2]=T,h[L+3]=255}s.putImageData(m,0,0);let d=i.toDataURL(),u=`${e.name.replace(/_height(map)?/i,"")}_ao`;if(e instanceof TextureLayer){let p=new TextureLayer({name:u,data_url:d,visible:!0},e.texture);return p.addForEditing(),p}let b=new Texture({name:u,saved:!1,particle:!1,keep_size:!1}).fromDataURL(d);return Project&&b.add(),b}y.push(()=>{o.generateNormal=new Action("generate_normal",{icon:g.normal.icon??"altitude",name:"Generate Normal Map",description:"Generates a normal map from the height map",condition:()=>(A()??k())!==null,click(e){let a=A()??k()??Texture.getDefault();if(!a)return;let t=X(a);if(!t){Blockbench.showQuickMessage("Failed to generate normal map",2e3);return}t.select(e),new j(a instanceof Texture&&a.layers_enabled?a.layers:null,a.uuid).saveTexture(g.normal,t),Blockbench.showQuickMessage("Normal map generated",2e3)}}),o.generateAo=new Action("generate_ao",{icon:g.ao.icon??"motion_mode",name:"Generate Ambient Occlusion Map",description:"Generates an ambient occlusion map from the height map",condition:{selected:{texture:!0},project:!0},click(){let e=A()??k()??Texture.getDefault();if(!e)return;let a=new j(e instanceof Texture&&e.layers_enabled?e.layers:null,e.uuid),t=a.findTexture(g.normal)??X(e);if(!t){Blockbench.showQuickMessage("Unable to generate ambient occlusion map without a normal map",2e3);return}let r=me(t);if(r){a.saveTexture(g.ao,r),r.select(),Blockbench.showQuickMessage("Ambient occlusion map generated",2e3);return}Blockbench.showQuickMessage("Failed to generate ambient occlusion map",2e3)}}),MenuBar.addAction(o.generateNormal,"tools"),MenuBar.addAction(o.generateAo,"tools")});C.push(()=>{MenuBar.removeAction("tools.generate_normal")});var Je=(e,a="texture")=>{e.toBlob(async t=>{t&&Blockbench.export({content:await t.arrayBuffer(),type:"PNG",name:`${a}_n`,extensions:["png"],resource_id:"normal_map",savetype:"image"})})},Ze=(e,a="texture")=>{e.toBlob(async t=>{t&&Blockbench.export({content:await t.arrayBuffer(),type:"PNG",name:`${a}_s`,extensions:["png"],resource_id:"specular_map",savetype:"image"})})};y.push(()=>{o.generateLabPbr=new Action("generate_lab_pbr",{icon:"experiment",name:"Generate labPBR textures",description:"Generate a specular and normal map in labPBR format for Java shaders",condition:{formats:["java_block"],project:!0},async click(){let e=k();if(!e)return;let t=new j(e.layers_enabled?e.layers:[e],e.uuid).createLabPbrOutput();if(t===null)return;let r=e.name??(Project?Project.getDisplayName():"texture");await Promise.all([Je(t.normalMap,pathToName(r)),Ze(t.specular,pathToName(r))]),Blockbench.showQuickMessage("Exported labPBR textures")}}),o.decodeLabPbr=new Action("decode_lab_pbr",{icon:"frame_source",name:"Decode labPBR textures",description:"Decodes the selected texture into a specular or normal map in labPBR format",condition:{formats:["java"],project:!0,selected:{texture:!0}},click(){let e=TextureLayer.selected?.texture??Texture.all.find(t=>t.selected)??Texture.getDefault(),a=new j(e.layers_enabled?e.layers:[e],e.uuid);if(pathToName(e.name).endsWith("_n")){a.createTexturesFromNormal(e);return}if(pathToName(e.name).endsWith("_s")){a.createTexturesFromSpecular(e);return}Blockbench.showQuickMessage("Failed to decode labPBR texture")}}),MenuBar.addAction(o.generateLabPbr,"file.export"),MenuBar.addAction(o.decodeLabPbr,"tools")});C.push(()=>{MenuBar.removeAction("file.export.generate_lab_pbr")});y.push(()=>{o.createMaterialTexture=new Action("create_material_texture",{icon:"deployed_code",name:"Create Material Texture",description:"Creates a new texture for a PBR material",condition:{modes:["edit","paint"],project:!0},click(){if(!Project)return;let e={...g},a=new Texture({name:"New Material",saved:!1,particle:!1});a.extend({material:!0});let t=Texture.all.filter(s=>(s.selected||s.multi_selected)&&!s.material)??Texture.all,r=k(),n=r?new j(t,r.uuid):null;try{let s=n?.findTexture(g.albedo,!0)?.canvas.toDataURL()??r?.canvas.toDataURL()??Z(new v.Color(8421504),a.canvas);if(!s)return;a.fromDataURL(s);let l=new TextureLayer({name:e.albedo.label,visible:!0,data_url:s,keep_size:!0},a);l.extend({channel:e.albedo.id}),l.addForEditing(),l.texture.updateChangesAfterEdit(),n?.saveTexture(e.albedo,l),delete e.albedo}catch(s){console.warn("Failed to create base color texture",s),Blockbench.showStatusMessage("Failed to create base color texture in new material",3e3)}let i=Object.keys(e).reverse().map(s=>{let l=g[s],m=n?.findTexture(l,!0),h=m?m.canvas.toDataURL():Z(l.default??new v.Color(0));if(!h)return;let d=new TextureLayer({name:l.label,visible:!0,data_url:h,keep_size:!0},a);return d.extend({channel:l.id}),n?.saveTexture(l,d),d}).filter(Boolean);Undo.initEdit({textures:Texture.all,layers:i}),a.add().select(),a.activateLayers(),i.map(s=>{s.addForEditing(),a.width=Math.max(a.width,s.img.width),a.height=Math.max(a.height,s.img.height)}),a.updateChangesAfterEdit(),Undo.finishEdit("Create Material Texture")}}),MenuBar.addAction(o.createMaterialTexture,"tools"),Toolbars.texturelist.add(o.createMaterialTexture,3)});C.push(()=>{MenuBar.removeAction("tools.create_material_texture"),Toolbars.texturelist.remove("create_material_texture")});var F=(e,a)=>{let t=k()??Texture.getDefault(),r=new j(t.layers_enabled?t.layers:Project?Project.textures:null,t.uuid).createMer(!0);if(!r)throw new Error("Failed to generate MER map from selected texture.");r.toBlob(async n=>{if(!n)throw new Error("Failed to save MER map.");let[i,s]=Project?[e?`${e}_mer`:`${t.name??Project.getDisplayName()}_mer`,Project.export_path]:["mer"];Blockbench.export({content:await n.arrayBuffer(),type:"PNG",name:i,extensions:["png"],resource_id:"mer",savetype:"image",startpath:s},a)})};y.push(()=>{o.generateMer=new Action("create_mer",{icon:"lightbulb_circle",name:"Export MER",description:"Exports a texture map from the metalness, emissive, and roughness channels. (For use in Bedrock resource packs.)",condition:{formats:["bedrock","bedrock_block"],project:!0},click(){try{F()}catch(e){console.error("Failed to export MER map:",e),Blockbench.showStatusMessage("Failed to export MER map",3e3)}}}),o.decodeMer=new Action("decode_mer",{name:"Decode MER",icon:"arrow_split",condition:{formats:["bedrock","bedrock_block"],project:!0,selected:{texture:!0}},children:[{icon:"move_item",name:"Decode MER to Textures",description:"Decodes a MER texture map into metalness, emissive, and roughness channels into separate textures",click(){let e=k()??Texture.getDefault(),a=new j([e],e.uuid),t=a.decodeMer(),r=[g.metalness,g.emissive,g.roughness];Undo.initEdit({textures:[e]}),r.forEach(n=>{let i=n.id,s=t[i];if(!s){Blockbench.showStatusMessage(`Failed to decode ${n.label} channel`,3e3);return}let l=new Texture({name:`${e?.name}_${i}`,keep_size:!1}).fromDataURL(s.toDataURL());l.add(!0),a.saveTexture(n,l)}),Undo.finishEdit("Decode MER to textures")}},{icon:"move_group",name:"Decode MER to Layers",description:"Decodes a MER texture map into metalness, emissive, and roughness channels into material layers",condition:()=>k()?.layers_enabled===!0,click(){let e=k()??Texture.getDefault(),a=new j(e.layers_enabled?e.layers:[e],e.uuid),t=a.decodeMer(),r=[g.metalness,g.emissive,g.roughness];Undo.initEdit({textures:[e]}),r.forEach(n=>{let i=n.id,s=t[i];if(!s){Blockbench.showStatusMessage(`Failed to decode ${n.label} channel`,3e3);return}let l=new TextureLayer({name:`${e?.name}_${i}`,data_url:s.toDataURL()},e);a.saveTexture(n,l),l.addForEditing()}),Undo.finishEdit("Decode MER to layers")}}],click(){}}),MenuBar.addAction(o.decodeMer,"tools"),MenuBar.addAction(o.generateMer,"file.export")});C.push(()=>{MenuBar.removeAction("file.export.create_mer"),MenuBar.removeAction("tools.decode_mer")});var We=()=>{Project&&Project.textures.forEach(e=>{let a=new j(null,e.uuid),t=a.findTexture(g.normal,!1),r=a.findTexture(g.height,!1),n=a.findTexture(g.albedo,!1),i=a.findTexture(g.metalness,!1)?.name,s=a.findTexture(g.emissive,!1)?.name,l=a.findTexture(g.roughness,!1)?.name,m={};return n||(m.baseColor={type:"color",label:"Base Color",value:"#ff00ff"}),!i&&!s&&!l&&(m.metalness={label:"Metalness",type:"range",min:0,max:255,step:1,value:0},m.emissive={label:"Emissive",type:"range",min:0,max:255,step:1,value:0},m.roughness={label:"Roughness",type:"range",min:0,max:255,step:1,value:0}),t&&(m.depthMap={type:"checkbox",label:"Normal Map",value:"normal"}),r&&(m.depthMap={type:"checkbox",label:"Height Map",value:"heightmap"}),t&&r&&(m.depthMap={type:"radio",label:"Depth Map",options:{normal:"Normal Map",heightmap:"Height"},value:"normal"}),o.textureSetDialog=new Dialog("texture_set",{id:"texture_set",title:"Create Texture Set JSON",buttons:["Create","Cancel"],form:m,cancelIndex:1,onConfirm(h){let d=$(),u=i||s||l,b={format_version:"1.16.100","minecraft:texture_set":{color:(n?d:h.baseColor?.toHexString())??d,metalness_emissive_roughness:[h.metalness??0,h.emissive??0,h.roughness??255]}};h.depthMap==="normal"&&t||!r&&t?b["minecraft:texture_set"].normal=`${d}_normal`:(!t||h.depthMap==="heightmap")&&r&&(b["minecraft:texture_set"].heightmap=`${d}_heightmap`);let p=x=>{if(!h.depthMap)return x();let _=h.depthMap==="normal"||h.depthMap&&!r,M=_?t:r;if(!M)return x();Blockbench.export({content:M.canvas.toDataURL()??"",type:"PNG",name:`${d}_${_?"normal":"heightmap"}`,extensions:["png"],resource_id:h.depthMap,startpath:Project.export_path,savetype:"image"},w=>{b["minecraft:texture_set"][_?"normal":"heightmap"]=pathToName(w,!1),x()})},f=x=>{if(!n)return x();Blockbench.export({content:n.canvas.toDataURL(),extensions:["png"],type:"PNG",name:d,startpath:Project.export_path,savetype:"image"},_=>{b["minecraft:texture_set"].color=pathToName(_,!1),x()})},c=()=>p(()=>{f(()=>{Blockbench.export({content:JSON.stringify(b,null,2),type:"JSON",name:`${d}.texture_set`,extensions:["json"],resource_id:"texture_set",startpath:Project.export_path,savetype:"text"},()=>{Blockbench.showQuickMessage("Texture set created",2e3),o.textureSetDialog?.hide()})})});if(u){try{F(d,x=>{b["minecraft:texture_set"].metalness_emissive_roughness=pathToName(x,!1),c()})}catch(x){console.warn("Failed to export MER map:",x),Blockbench.showStatusMessage("Failed to export MER map",3e3)}return}c()}}),o.textureSetDialog.show()})};y.push(()=>{o.createTextureSet=new Action("create_texture_set",{name:"Create Texture Set",icon:"layers",description:"Creates a texture set JSON file. Generates a MER when metalness, emissive, or roughness channels are set.",click(){We()},condition:{formats:["bedrock","bedrock_block"],project:!0}}),MenuBar.addAction(o.createTextureSet,"file.export")});C.push(()=>{MenuBar.removeAction("file.export.create_texture_set")});y.push(()=>{o.toggleCorrectLights=new Toggle("correct_lights",{category:"preview",name:"Correct Lights",description:"Corrects the lighting in the preview",icon:"fluorescent",default:!1,onChange(e){Preview.all.forEach(a=>{a.renderer.physicallyCorrectLights=e}),Preview.selected.renderer.physicallyCorrectLights=e,Blockbench.showQuickMessage(`Physically corrected lighting is now ${e?"enabled":"disabled"}`,2e3),e&&o.togglePbr?.set(!0),R()},click(){}}),MenuBar.addAction(o.toggleCorrectLights,"preview")});C.push(()=>{MenuBar.removeAction("preview.correct_lights")});var z=()=>{!Project||!Project.bb_materials||(Project.elements.forEach(e=>{e instanceof Cube&&Object.keys(e.faces).forEach(a=>{let r=e.faces[a].getTexture();if(!r)return;let n=Project.bb_materials[r.uuid];n&&(Project.materials[r.uuid]=n)})}),Project.pbr_active=!1,Canvas.updateAll())};var de=["undo","redo","add_texture","finish_edit","finished_edit","load_project","select_preview_scene","change_texture_path","select_project","load_undo_save","add_cube"],he=()=>Project&&Project.pbr_active&&R(),qe=()=>{Blockbench.on(de.join(" "),he)},pe=()=>{de.forEach(e=>{Blockbench.removeListener(e,he)})};y.push(()=>{o.togglePbr=new Toggle("toggle_pbr",{name:"PBR Preview",description:"Toggle PBR Preview",icon:"panorama_photosphere",category:"view",default:!1,click(){},onChange(e){if(e){R(),qe(),Blockbench.showQuickMessage("PBR Preview is now enabled");return}z(),pe(),Blockbench.showQuickMessage("PBR Preview is now disabled")}}),MenuBar.addAction(o.togglePbr,"view")});C.push(()=>{pe(),MenuBar.removeAction("view.toggle_pbr")});var ge=e=>{let a=Math.max(-2,Math.min(2,e));Preview.all.forEach(t=>{t.renderer.toneMappingExposure=a}),Preview.selected.renderer.toneMappingExposure=a};y.push(()=>{o.exposureSlider=new NumSlider("display_settings_exposure",{category:"preview",name:"Exposure",description:"Adjusts the exposure of the scene",type:"number",value:1,icon:"exposure",settings:{min:-2,max:2,step:.01,default:1},onBefore(){Number(o.tonemappingSelect?.get())===v.NoToneMapping&&o.tonemappingSelect.change(v.LinearToneMapping.toString()),o.togglePbr?.set(!0)},onChange(e){ge(Number(e))},onAfter(){N()}}),o.resetExposureButton=new Action("display_settings_reset_exposure",{category:"preview",name:"Reset Exposure",description:"Resets the exposure of the scene",icon:"exposure_plus_1",condition:()=>o.exposureSlider!==void 0&&Number(o.exposureSlider?.get())!==1,click(){ge(1),o.exposureSlider?.setValue(1,!0),N()}}),o.tonemappingSelect=new BarSelect("display_settings_tone_mapping",{category:"preview",name:"Tone Mapping",description:"Changes the tone mapping of the preview",type:"select",default_value:v.NoToneMapping,value:Preview.selected.renderer.toneMapping??v.NoToneMapping,icon:"monochrome_photos",options:{[v.NoToneMapping]:"No Tone Mapping",[v.LinearToneMapping]:"Linear",[v.ReinhardToneMapping]:"Reinhard",[v.CineonToneMapping]:"Cineon",[v.NeutralToneMapping]:"Neutral",[v.ACESFilmicToneMapping]:"ACES"},onChange({value:e}){Preview.selected.renderer.toneMapping=Number(e);let a=1;Preview.selected.renderer.toneMapping===v.NoToneMapping?o.exposureSlider?.setValue(a,!0):a=Number(o.exposureSlider?.get()??1),Preview.all.forEach(t=>{t.renderer.toneMapping=Number(e),t.renderer.toneMappingExposure=a}),Preview.selected.renderer.toneMappingExposure=a,Blockbench.showQuickMessage(`Tone mapping set to ${this.getNameFor(e)}`,2e3),o.togglePbr&&!o.togglePbr.value&&o.togglePbr.set(!0),R()}})});var K=class{async parse(a){let t=new ne,r="model.usda";t.file(r,"");let n=ve(),i={},s={};a.traverseVisible(h=>{if(!h.isMesh)return;let d=h;if(!d.material.isMeshStandardMaterial){console.warn("THREE.USDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)",h);return}let u=d.geometry,b=d.material,p="geometries/Geometry_"+u.id+".usd";if(!t.file(p)){let f=tt(u);t.file(p,Ke(f))}b.uuid in i||(i[b.uuid]=b),n+=Ye(d,u,b)}),n+=ot(i,s),t.file(r,n),n=null;for(let h in s){let d=s[h],u=h.split("_")[1],b=d.format===v.RGBAFormat,p=Xe(d.image,u),c=await(await new Promise(x=>p.toBlob(_=>_&&x(_),b?"image/png":"image/jpeg",1))).arrayBuffer();t.file(`textures/Texture_${h}.${b?"png":"jpg"}`,c)}let l=0;t.forEach(async h=>{let d=34+h.length;l+=d;let u=l&63,b=await t.file(h).async("uint8array");if(u!==4){let p=64-u,f=new Uint8Array(p),c=new Uint8Array(b.length+p);c.set(b,0),c.set(f,b.length),t.file(h,c)}l+=b.length});let m=await t.generateAsync({type:"blob",compression:"STORE"});return new Uint8Array(await m.arrayBuffer())}};function Xe(e,a){if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&e instanceof ImageBitmap){let t=1024/Math.max(e.width,e.height),r=document.createElement("canvas");r.width=e.width*Math.min(1,t),r.height=e.height*Math.min(1,t);let n=r.getContext("2d");if(n.imageSmoothingEnabled=!1,n.drawImage(e,0,0,r.width,r.height),a!==void 0){let i=parseInt(a,16),s=(i>>16&255)/255,l=(i>>8&255)/255,m=(i&255)/255,h=n.getImageData(0,0,r.width,r.height),d=h.data;for(let u=0;u<d.length;u+=4)d[u+0]=d[u+0]*s,d[u+1]=d[u+1]*l,d[u+2]=d[u+2]*m;n.putImageData(h,0,0)}return r}throw new Error("Unsupported image type")}var H=7;function ve(){return`#usda 1.0
(
    customLayerData = {
        string creator = "Blockbench USDZExporter"
    }
    metersPerUnit = 1
    upAxis = "Y"
)

`}function Ke(e){let a=ve();return a+=e,a}function Ye(e,a,t){let r="Object_"+e.id,n=et(e.matrixWorld);return e.matrixWorld.determinant()<0&&console.warn("THREE.USDZExporter: USDZ does not support negative scales",e),`def Xform "${r}" (
    prepend references = @./geometries/Geometry_${a.id}.usd@</Geometry>
)
{
    matrix4d xformOp:transform = ${n}
    uniform token[] xformOpOrder = ["xformOp:transform"]

    rel material:binding = </Materials/Material_${t.id}>
}

`}function et(e){let a=e.elements;return`( ${G(a,0)}, ${G(a,4)}, ${G(a,8)}, ${G(a,12)} )`}function G(e,a){return`(${e[a+0]}, ${e[a+1]}, ${e[a+2]}, ${e[a+3]})`}function tt(e){return`
def "Geometry"
{
  ${at(e)}
}
`}function at(e){let a="Geometry",t=e.attributes,r=t.position.count;return`
    def Mesh "${a}"
    {
        int[] faceVertexCounts = [${rt(e)}]
        int[] faceVertexIndices = [${nt(e)}]
        normal3f[] normals = [${fe(t.normal,r)}] (
            interpolation = "vertex"
        )
        point3f[] points = [${fe(t.position,r)}]
        float2[] primvars:st = [${st(t.uv,r)}] (
            interpolation = "vertex"
        )
        uniform token subdivisionScheme = "none"
    }
`}function rt(e){let a=e.index!==null?e.index.count:e.attributes.position.count;return Array(a/3).fill(3).join(", ")}function nt(e){let a=e.index,t=[];if(a!==null)for(let r=0;r<a.count;r++)t.push(a.getX(r));else{let r=e.attributes.position.count;for(let n=0;n<r;n++)t.push(n)}return t.join(", ")}function fe(e,a){if(e===void 0)return console.warn("USDZExporter: Normals missing."),Array(a).fill("(0, 0, 0)").join(", ");let t=[];for(let r=0;r<e.count;r++){let n=e.getX(r),i=e.getY(r),s=e.getZ(r);t.push(`(${n.toPrecision(H)}, ${i.toPrecision(H)}, ${s.toPrecision(H)})`)}return t.join(", ")}function st(e,a){if(e===void 0)return console.warn("USDZExporter: UVs missing."),Array(a).fill("(0, 0)").join(", ");let t=[];for(let r=0;r<e.count;r++){let n=e.getX(r),i=e.getY(r);t.push(`(${n.toPrecision(H)}, ${Number(i.toPrecision(H))})`)}return t.join(", ")}function ot(e,a){let t=[];for(let r in e){let n=e[r];t.push(it(n,a))}return`def "Materials"
{
${t.join("")}
}

`}function it(e,a){let t="            ",r=[],n=[];function i(l,m,h){let d=l.id+(h?"_"+h.getHexString():""),u=l.format===v.RGBAFormat;return a[d]=l,`
        def Shader "Transform2d_${m}" (
            sdrMetadata = {
                string role = "math"
            }
        )
        {
            uniform token info:id = "UsdTransform2d"
            float2 inputs:in.connect = </Materials/Material_${e.id}/uvReader_st.outputs:result>
            float2 inputs:scale = ${be(l.repeat)}
            float2 inputs:translation = ${be(l.offset)}
            float2 outputs:result
        }

        def Shader "Texture_${l.id}_${m}"
        {
            uniform token info:id = "UsdUVTexture"
            asset inputs:file = @textures/Texture_${d}.${u?"png":"jpg"}@
            float2 inputs:st.connect = </Materials/Material_${e.id}/Transform2d_${m}.outputs:result>
            token inputs:wrapS = "repeat"
            token inputs:wrapT = "repeat"
            float outputs:r
            float outputs:g
            float outputs:b
            float3 outputs:rgb
        }`}let s=e;if(s.map!==null?(r.push(`${t}color3f inputs:diffuseColor.connect = </Materials/Material_${s.id}/Texture_${s.map.id}_diffuse.outputs:rgb>`),n.push(i(s.map,"diffuse",s.color))):r.push(`${t}color3f inputs:diffuseColor = ${xe(s.color)}`),s.emissiveMap!==null?(r.push(`${t}color3f inputs:emissiveColor.connect = </Materials/Material_${s.id}/Texture_${s.emissiveMap.id}_emissive.outputs:rgb>`),n.push(i(s.emissiveMap,"emissive"))):s.emissive.getHex()>0&&r.push(`${t}color3f inputs:emissiveColor = ${xe(s.emissive)}`),s.normalMap!==null&&(r.push(`${t}normal3f inputs:normal.connect = </Materials/Material_${s.id}/Texture_${s.normalMap.id}_normal.outputs:rgb>`),n.push(i(s.normalMap,"normal"))),s.aoMap!==null&&(r.push(`${t}float inputs:occlusion.connect = </Materials/Material_${s.id}/Texture_${s.aoMap.id}_occlusion.outputs:r>`),n.push(i(s.aoMap,"occlusion"))),s.roughnessMap!==null&&s.roughness===1?(r.push(`${t}float inputs:roughness.connect = </Materials/Material_${s.id}/Texture_${s.roughnessMap.id}_roughness.outputs:g>`),n.push(i(s.roughnessMap,"roughness"))):r.push(`${t}float inputs:roughness = ${s.roughness}`),s.metalnessMap!==null&&s.metalness===1?(r.push(`${t}float inputs:metallic.connect = </Materials/Material_${s.id}/Texture_${s.metalnessMap.id}_metallic.outputs:b>`),n.push(i(s.metalnessMap,"metallic"))):r.push(`${t}float inputs:metallic = ${s.metalness}`),s.alphaMap!==null?(r.push(`${t}float inputs:opacity.connect = </Materials/Material_${s.id}/Texture_${s.alphaMap.id}_opacity.outputs:r>`),r.push(`${t}float inputs:opacityThreshold = 0.0001`),n.push(i(s.alphaMap,"opacity"))):r.push(`${t}float inputs:opacity = ${s.opacity}`),s.isMeshPhysicalMaterial){let l=s;r.push(`${t}float inputs:clearcoat = ${l.clearcoat}`),r.push(`${t}float inputs:clearcoatRoughness = ${l.clearcoatRoughness}`),r.push(`${t}float inputs:ior = ${l.ior}`)}return`
    def Material "Material_${s.id}"
    {
        def Shader "PreviewSurface"
        {
            uniform token info:id = "UsdPreviewSurface"
${r.join(`
`)}
            int inputs:useSpecularWorkflow = 0
            token outputs:surface
        }

        token outputs:surface.connect = </Materials/Material_${s.id}/PreviewSurface.outputs:surface>
        token inputs:frame:stPrimvarName = "st"

        def Shader "uvReader_st"
        {
            uniform token info:id = "UsdPrimvarReader_float2"
            token inputs:varname.connect = </Materials/Material_${s.id}.inputs:frame:stPrimvarName>
            float2 inputs:fallback = (0.0, 0.0)
            float2 outputs:result
        }

${n.join(`
`)}

    }
`}function xe(e){return`(${e.r}, ${e.g}, ${e.b})`}function be(e){return`(${e.x}, ${e.y})`}var _e=K;y.push(()=>{let e=new Codec("usdz",{extension:"usdz",name:"USDZ",remember:!0,export_options:{},fileName(){return $()+".usdz"},async compile(a={}){if(!Project)throw new Error("No project loaded");R();let t=Object.assign(this.getExportOptions(),a),r=new _e,n=new v.Scene;n.name="blockbench_export",n.add(Project.model_3d);let i=await r.parse(n);return this.dispatchEvent("compile",{model:i,options:t}),Canvas.scene.add(Project.model_3d),i},async export(){let a=await this.compile();Blockbench.export({content:a,name:this.fileName(),startpath:this.startPath(),resource_id:"usdz",type:this.name,extensions:["usdz"],savetype:"buffer"},t=>this.afterDownload(t))}});o.exportUsdz=new Action("export_usdz",{category:"file",name:"Export USDZ",description:"Exports the current model as a USDZ file",icon:"stacks",async click(){e&&await e.export()}}),o.usdz=e,MenuBar.addAction(o.exportUsdz,"file.export")});C.push(()=>{MenuBar.removeAction("file.export_usdz")});var Me="1.0.0";y.push(()=>{o.bbmat=new Codec("material",{name:"Blockbench Material",extension:"bbmat",remember:!1,load_filter:{extensions:["bbmat"],type:"json"},compile(e){if(!Texture.selected?.material||!Texture.selected?.layers_enabled)return;let a=Texture.selected.layers.map(r=>{let n=r.channel,i=r.canvas.toDataURL();return[n,i]}),t=new j(Texture.selected.layers,Texture.selected.uuid);return a.push(["preview",t.renderMaterialPreview()]),JSON.stringify({version:Me,channels:Object.fromEntries(a)})},parse(e,a){return e=typeof e=="string"?JSON.parse(e):e,e.version!==Me?{}:e.channels},load(e,a,t){if(!Project)return;let r=this.parse(e,a.path),n=Object.keys(r);if(!n.length)throw new Error("No valid channels found in the material");let i=r[g.albedo.id]??r[n[0]];n.includes("preview")&&(i=r.preview);let s=new Texture({name:pathToName(a.name),saved:!0,particle:!1,source:i,layers_enabled:!0});s.extend({material:!0});let l=n.map(m=>{if(!(m in g))return null;let h=r[m],d=new TextureLayer({name:m,data_url:h,visible:!0},s);return d.extend({channel:m}),d}).filter(Boolean);if(!l.length)throw new Error("No valid channel layers found in the material");i||s.fromDataURL(l[0].canvas.toDataURL()),s.add().select(),l.forEach(m=>{m.addForEditing(),s.width=Math.max(s.width,m.img.width),s.height=Math.max(s.height,m.img.height)}),s.updateChangesAfterEdit()},export(){Blockbench.export({resource_id:"material",type:this.name,extensions:[this.extension],name:`${Texture.selected?.name??this.fileName??"material"}.bbmat`,startpath:this.startPath(),content:this.compile()},e=>this.afterDownload(e))}}),o.bbMatExport=new Action("export_bbmat",{icon:"stacks",name:"Save as .bbmat",category:"file",condition:{project:!0,selected:{texture:!0},method(){return Texture.selected?.material}},click(){!o.bbmat?.write||!o.bbmat?.compile||o.bbmat.export&&o.bbmat.export()}}),o.bbMatImport=new Action("import_bbmat",{icon:"stacks",name:"Import .bbmat",category:"file",condition:{project:!0},click(){Blockbench.import({extensions:["bbmat"],type:"json",title:"Import .bbmat",multiple:!0},e=>{o.bbmat?.load&&e.forEach(a=>{o.bbmat.load(a.content,a,!0)})})}}),o.bbmat.export_action=o.bbMatExport,Texture.prototype.menu.addAction(o.bbMatExport),MenuBar.addAction(o.bbMatImport,"file.import")});C.push(()=>{Texture.prototype.menu.removeAction("export_bbmat"),MenuBar.removeAction("file.import.import_bbmat")});var V=class e{constructor({colors:a}){this._colors={...Object.fromEntries(Object.keys(g).map(t=>[t,g[t].default??new v.Color(4294967040)])),...a}}get colors(){return this._colors}set colors(a){this._colors={...this._colors,...a}}toString(){let a=Object.entries(this._colors).map(([t,r])=>[t,r.getHexString()]);return JSON.stringify(a)}getChannel(a){return this._colors[a]}static makeLinearColor(a){let t=Math.min(1,Math.max(0,a));return new v.Color(t,t,t).convertSRGBToLinear()}static fromSettings(){let a="#000000",t=Number(o.brushMetalnessSlider?.get()),r=Number(o.brushRoughnessSlider?.get()??1),n=(o.brushEmissiveColor?.get()??a).toString(),i=Number(o.brushHeightSlider?.get()),s=ColorPanel.get(),l={[g.albedo.id]:new v.Color(s),[g.metalness.id]:e.makeLinearColor(t),[g.roughness.id]:e.makeLinearColor(r),[g.emissive.id]:new v.Color(n??a),[g.height.id]:e.makeLinearColor(i),[g.normal.id]:g.normal.default??new v.Color("#8080ff")};return new e({colors:l})}};var ye="materialBrushPresets",Y=()=>JSON.parse(localStorage.getItem(ye)||"{}"),lt=(e,a)=>{let t=Y(),r=a??guid(),n=o.userMaterialBrushPresets?.getFormResult()??{},i={};return n.albedo&&(i.albedo=n.albedo.toString()),n.metalness&&(i.metalness=Number(n.metalness)),n.roughness&&(i.roughness=Number(n.roughness)),n.emissive&&(i.emissive=n.emissive.toString()),n.height&&(i.height=Number(n.height)),t[r]=[i,e??"New Preset",U(i)],localStorage.setItem(ye,JSON.stringify(t)),r},we=({metalness:e,roughness:a,emissive:t,height:r,albedo:n})=>{e!==void 0&&o.brushMetalnessSlider?.setValue(e||0,!0),a!==void 0&&o.brushRoughnessSlider?.setValue(a??1,!0),t!==void 0&&o.brushEmissiveColor?.set(t??"#000000"),r!==void 0&&o.brushHeightSlider?.setValue(Math.max(0,Math.min(1,r??.5)),!0),n!==void 0&&ColorPanel.set(n)},Q=({id:e})=>Condition({project:!0,tools:["material_brush"],method(){let a=k();return(a?.layers_enabled&&a.layers.find(({channel:t})=>t&&t===e)!==void 0)===!0}}),ct=re.extend({name:"UserPresetsDialog",data(){return{userPresets:{},channels:g}},methods:{applyPreset(e){try{let[a,t]=this.userPresets[e],{metalness:r,roughness:n,emissive:i,height:s,albedo:l}=a;we({metalness:Number(r),roughness:Number(n),emissive:i.toString(),height:Number(s),albedo:l.toString()}),o.userMaterialBrushPresets?.hide(),Blockbench.showQuickMessage(`Preset "${t}" applied`,2e3)}catch{Blockbench.showQuickMessage("Failed to apply preset",2e3)}},deletePreset(e){Blockbench.showMessageBox({title:"Delete Preset",message:"Are you sure you want to delete this preset?",confirm:1,cancel:0,buttons:["Cancel","Delete"],checkboxes:{},width:400},a=>{if(a){let t=Y(),r=this.userPresets[e][1]??e;delete t[e],localStorage.setItem("materialBrushPresets",JSON.stringify(t)),this.userPresets=t,Blockbench.showQuickMessage(`Preset "${r}" deleted`,2e3)}})},editPreset(e){o.userMaterialBrushPresets?.setFormValues({name:this.userPresets[e][1]??e,...this.userPresets[e][0]})},getSummary(e){return Object.entries(e).filter(([a])=>a in this.channels).map(([a,t])=>a==="albedo"||a==="emissive"?`${this.channels[a]?.label??a}: ${t}`:`${this.channels[a]?.label??a}: ${Number(t).toFixed(1)}`).join(`
`)}},computed:{presets(){return Object.entries(this.userPresets)}},mounted(){this.userPresets=Y()},template:`
    <div>
      <ul class="list mobile_scrollbar preset_list">
        <li
          v-for="([key, [settings, name, image]]) in presets"
          :key="key"
          class="user_preset"
        >
          <div v-if="image" class="preset_preview" @click="editPreset(key)">
            <img :src="image" :alt="name" :title="getSummary(settings)" width="96" height="96" />
            <div class="preset_title">{{ name }}</div>
          </div>
          <div v-else>
            <div class="preset_title" @click="editPreset(key)" :title="getSummary(settings)">{{ name }}</div>
          </div>
          <div class="preset_buttons">
            <button class="delete_preset" type="button" @click="deletePreset(key)">
              <i class="material-icons">close</i>
            </button>
          </div>
        </li>
      </ul>
    </div>`});y.push(()=>{o.materialBrushStyles=Blockbench.addCSS(`
  .preset_list {
    display: grid;
    grid-template-columns: repeat(auto-fill, 96px);
    grid-gap: 8px;
    justify-content: start;
    align-items: start;
    margin: 0 auto;
    padding: 8px;
  }

  .user_preset {
    display: flex;
    justify-content: start;
    align-items: center;
    width: 100%;
    padding: 8px;
    position: relative;
  }

  .preset_title {
    font-size: 1em;
    color: var(--color-text);
  }

  .user_preset:hover .preset_title {
    color: var(--color-accent);
  }

  .preset_preview {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  .preset_buttons {
    display: flex;
    flex-direction: row;
    align-items: center;
    font-size: 0.8em;
    padding: 0 4px;
  }

  .preset_channel {
    display: flex;
    flex-direction: row;
    align-items: center;
    margin: 0 8px;
    font-size: 0.8em;
  }

  .delete_preset {
    margin-left: 8px;
    padding: 4px;
    height: 24px;
    width: 24px;
    min-width: 24px;
    background-color: transparent;
    color: var(--color-text);
    border: none;
    border-radius: 100%;
    position: absolute;
    right: -8px;
    top: 0;
    filter: drop-shadow(0 0 2px var(--color-shadow));
  }

  .delete_preset:hover {
    background: transparent;
    color: var(--color-accent);
  }

  .delete_preset .material-icons {
    font-size: 0.825em;
  }

  .delete_preset:hover .material-icons {
    color: var(--color-accent);
  }`),o.brushMetalnessSlider=new NumSlider("slider_brush_metalness",{category:"paint",name:"Metalness",description:"Adjust the metalness of the brush",tool_setting:"brush_metalness",settings:{min:0,max:1,step:.01,default:0},condition:()=>Q(g.metalness)}),o.brushRoughnessSlider=new NumSlider("slider_brush_roughness",{category:"paint",name:"Roughness",description:"Adjust the roughness of the brush",tool_setting:"brush_roughness",settings:{min:0,max:1,step:.01,default:1},condition:()=>Q(g.roughness)}),o.brushEmissiveColor=new ColorPicker("brush_emissive_color",{category:"paint",name:"Emissive",description:"Adjust the emissive color of the brush",value:"#000000",tool_setting:"brush_emissive",condition:()=>Q(g.emissive)}),o.brushHeightSlider=new NumSlider("slider_brush_height",{category:"paint",name:"Height",description:"Adjust the height of the brush",tool_setting:"brush_height",settings:{min:0,max:1,step:.01,default:.5},condition:()=>Q(g.height)}),o.materialBrushTool=new Tool("material_brush",{name:"Material Brush",description:"Paints across multiple texture layers",icon:"view_in_ar",paintTool:!0,cursor:"cell",category:"tools",toolbar:"brush",condition:{project:!0,selected:{texture:!0},modes:["paint"],method(){return k()?.layers_enabled??!1}},allowed_view_modes:"textured",tool_settings:{brush_metalness:0,brush_roughness:1,brush_emissive:"#000000",brush_height:.5},brush:{blend_modes:!1,shapes:!0,size:!0,softness:!0,opacity:!0,offset_even_radius:!0,floor_coordinates:!0,changePixel(e,a,t,r,{size:n,softness:i,texture:s,x:l,y:m}){let h=V.fromSettings(),d=Object.keys(h.colors),u=Math.floor(n-i*n/100),b=t;return s.layers.forEach(p=>{if(!p.visible||!d.includes(p.channel))return;let f=h.getChannel(p.channel);if(!f)return;let c=Math.sqrt((l-e)**2+(m-a)**2),x=Math.min(1,c/u);if(l%u<=x&&m%u<=x){let _=p.ctx.getImageData(e,a,1,1).data,M=new v.Color(`rgb(${_[0]}, ${_[1]}, ${_[2]})`);f.lerp(M,1)}p.ctx.fillStyle=f.getStyle(),p.ctx.fillRect(e,a,1,1),p.selected&&(b={r:f.r*255,g:f.g*255,b:f.b*255,a:r*255})}),b}},onCanvasClick(e){Painter.startPaintToolCanvas(e,e.event)},onSelect(){Painter.updateNslideValues(),R()},click(){N()}}),o.loadBrushPreset=new Action("load_brush_preset",{icon:"stroke_full",name:"Material Brush Presets",description:"Load or save a brush preset",category:"paint",condition:{project:!0},click(){o.userMaterialBrushPresets=new Dialog("user_brush_presets",{id:"user_brush_presets",title:"Edit Material Brush",component:ct,part_order:["lines","component","form"],form:{albedo:{type:"color",label:"Albedo",value:ColorPanel.get(),toggle_enabled:!0},metalness:{type:"number",label:"Metalness",min:0,max:1,step:.01,full_width:!1,toggle_enabled:!0},roughness:{type:"number",label:"Roughness",min:0,max:1,step:.01,toggle_enabled:!0,full_width:!1},emissive:{type:"color",label:"Emissive",value:"#000000",toggle_enabled:!0},height:{type:"number",label:"Height",min:0,max:1,step:.01,toggle_enabled:!0}},onConfirm(e){we({metalness:Number(e.metalness??o.brushMetalnessSlider?.get()),roughness:Number(e.roughness??o.brushRoughnessSlider?.get()),emissive:(e.emissive??o.brushEmissiveColor?.get()).toString(),height:Number(e.height??o.brushHeightSlider?.get()),albedo:(e.albedo??ColorPanel.get()).toString()})},buttons:["Close","Save","Apply"],cancelIndex:0,confirmIndex:2,onButton(e,a){o.materialBrushTool?.select(),e===1&&Blockbench.textPrompt("Save Preset","New Preset",t=>{t&&(lt(t),Blockbench.showQuickMessage(`Preset "${t}" saved`,2e3))})}}).show()}}),MenuBar.addAction(o.materialBrushTool,"tools.0")});C.push(()=>{MenuBar.removeAction("tools.material_brush")});y.push(()=>{o.materialBrushPanel=new Panel("material_brush_panel",{name:"Material Brush",id:"material_brush_panel",icon:"view_in_ar",toolbars:[new Toolbar("material_brush_toolbar",{id:"material_brush_toolbar",children:["material_brush","load_brush_preset","slider_brush_metalness","slider_brush_roughness","brush_emissive_color","slider_brush_height"],name:"Material Settings"})],condition:{modes:["paint"],project:!0},component:{},expand_button:!0,growable:!1,onFold(){},onResize(){},default_side:"right",default_position:{slot:"right_bar",float_position:[0,0],float_size:[400,300],height:300,folded:!1},insert_after:"color",insert_before:"outliner"})});y.push(()=>{o.displaySettingsPanel=new Panel("display_settings",{name:"PBR Controls",id:"display_settings_panel",icon:"display_settings",toolbars:[new Toolbar("controls_toolbar",{id:"controls_toolbar",children:["toggle_pbr","correct_lights","display_settings_tone_mapping","display_settings_exposure","display_settings_reset_exposure","show_channel_select_menu"],name:"Display Settings"})],display_condition:{modes:["edit","paint","animate"],project:!0},component:{},expand_button:!0,growable:!1,onFold(){},onResize(){},default_side:"left",default_position:{slot:"left_bar",float_position:[0,0],float_size:[400,300],height:300,folded:!1},insert_after:"textures",insert_before:"color"})});var J=e=>e.visible&&e.channel&&e.channel!==B,ut=()=>{let e=A();if(e)return e.texture.layers.filter(J);let a=k();return a?a.layers_enabled?a.layers.filter(J):Texture.all.map(t=>t.layers_enabled?[...t.layers.filter(J)]:[J(t)?t:null]).flat().filter(Boolean):[]},Te=["select_texture","update_texture_selection","finish_edit","add_texture"],Ce=()=>{Panels.channels_panel.inside_vue.textures=ut()};y.push(()=>{o.channelsPanelStyle=Blockbench.addCSS(`
    .texture_channel {
      color: var(--color-text);
      flex: 1;
      font-size: 1em;
      margin: 0 0 0 auto;
      padding: 0 8px;
      text-align: right;
    }

    .texture_channel + .texture_particle_icon {
      padding-right: 8px;
    }

    .texture_channel_description {
      background-color: var(--color-back);
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      justify-content: space-between;
    }
    
    .texture_channel_wrapper {
      align-items: center;
      background-color: var(--color-ui);
      border-left: 1px solid var(--color-border);
      display: flex;
      flex: 1;
      flex-direction: row;
      align-items: center;
      flex-wrap: nowrap;
      padding: 0 8px;
    }

    .texture_channel_wrapper:hover {
      background-color: var(--color-button);
    }

    .texture_channel_description .texture_name {
      flex-direction: column;
      flex-wrap: nowrap;
      color: var(--color-subtle_text);
      display: flex;
      flex: 1;
      justify-content: center;
      align-items: start;
    }

    .texture_parent {
      color: var(--color-subtle_text);
      font-size: 0.8em;
    }

    .texture_channel_description:hover .texture_channel {
      color: var(--color-accent);
    }

    #pbr_channel_list {
      display: flex;
      flex-direction: column;
    }

    #pbr_channel_list .texture {
      border-top: 1px solid var(--color-border);
      padding-right: 0;
    }
  `),o.channelsPanel=new Panel("channels_panel",{name:"PBR Channels",id:"channels_panel",icon:"gallery_thumbnail",condition:{project:!0,selected:{texture:!0},modes:["paint","edit"]},toolbars:[],component:{name:"ChannelsPanel",data(){return{channels:g,textures:[]}},methods:{openMenu(e){o.channelMenu?.open(e)},selectTexture(e){Modes.options.paint.select(),e.select(),e.scrollTo()},channelEnabled(e){return e.channel&&e.channel!==B&&e.channel in this.channels},getImgSrc(e){return e.img?.src??`data:image/png;base64,${e.canvas.toDataURL()}`}},template:`
      <div>
        <ul class="list mobile_scrollbar" id="pbr_channel_list">
          <li
            v-for="texture in textures"
            v-on:click.stop="selectTexture(texture)"
            v-on:dblclick="openMenu($event)"
            :key="texture.uuid"
            class="texture"
          >
            <img :src="getImgSrc(texture)" :alt="texture.name" width="48" height="48" />
            <div class="texture_description_wrapper texture_channel_description">
              <div class="texture_name">
                <div>{{ texture.name }}</div>
                <div v-if="texture && texture.texture" class="texture_parent">
                  {{ texture.texture.name }}
                </div>
              </div>
              <div v-if="channelEnabled(texture)" class="texture_channel_wrapper">
                <div class="texture_channel">{{ channels[texture.channel].label }}</div>
                <i class="material-icons texture_particle_icon">{{ channels[texture.channel].icon }}</i>
              </div>
            </div>
          </li>
        </ul>
      </div>`},expand_button:!0,growable:!0,onFold(){},onResize(){},default_side:"left",default_position:{slot:"left_bar",float_position:[0,0],float_size:[400,300],height:350,folded:!0},insert_after:"layers",insert_before:"color"}),Blockbench.on(Te.join(" "),Ce)});C.push(()=>{Te.forEach(e=>{Blockbench.removeListener(e,Ce)})});(()=>{let e=()=>{y.forEach(t=>t())},a=()=>{z(),C.forEach(t=>t()),Object.entries(o).forEach(([t,r])=>{try{r?.delete()}catch(n){console.warn(`Failed to delete ${t} action:`,n)}})};BBPlugin.register("pbr_preview",{version:"1.1.0",title:"PBR Tools",author:"Jason J. Gardner",description:"Create and view PBR materials in Blockbench. Export textures for Java and RenderDragon shaders.",tags:["Minecraft: Java Edition","Minecraft: Bedrock Edition","PBR"],icon:"icon.png",variant:"both",await_loading:!0,repository:"https://github.com/jasonjgardner/blockbench-plugins",has_changelog:!0,min_version:"4.10.3",onload:e,onunload:a})})();})();
